<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URC Fantasy League - Simple Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üèâ URC Fantasy League</h1>
            <p class="text-white/80">Pick a team to WIN each round - lose and you're out!</p>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="max-w-md mx-auto bg-white rounded-xl card-shadow p-8 mb-8">
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button type="button" id="loginTab" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium">Login</button>
                <button type="button" id="registerTab" class="flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200">Register</button>
            </div>

            <form id="authForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div id="displayNameField" class="hidden">
                    <label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                    <input type="text" id="displayName" name="displayName"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <button type="submit" id="authButton"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                    <span id="buttonText">Login</span>
                </button>
            </form>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Welcome, <span id="userName"></span>!</h2>
                        <div class="flex gap-2">
                            <button id="toggleAdminBtn" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm">
                                Admin
                            </button>
                            <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel (for demo purposes) -->
                <div class="bg-yellow-50 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-yellow-800 mb-3">Demo Controls</h4>
                    <p class="text-sm text-yellow-700 mb-3">For demonstration purposes - advance rounds or simulate match results</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="advanceRoundBtn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                            Advance Round
                        </button>
                        <button id="simulateResultsBtn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            Simulate Results
                        </button>
                        <button id="resetGameBtn" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                            Reset Game
                        </button>
                        <button id="finalizeAllBtn" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">
                            Finalize All Pending
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Fantasy League</h3>

                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-blue-900 mb-2">How to Play:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>‚Ä¢ Pick one team per round from the available teams</li>
                            <li>‚Ä¢ If your team wins or draws, you advance to the next round</li>
                            <li>‚Ä¢ If your team loses, you're eliminated from the game</li>
                            <li>‚Ä¢ Each team can only be used once per player</li>
                            <li>‚Ä¢ Last player(s) remaining win the championship!</li>
                        </ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Leaderboard</h4>
                        <div id="leaderboard" class="space-y-2">
                            <!-- Leaderboard will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                        <button type="button" id="currentRoundTab" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium">Current Round</button>
                        <button type="button" id="allFixturesTab" class="flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200">All Fixtures</button>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="text-lg font-semibold text-blue-900" id="currentRoundDisplay">Round 1</h4>
                                <p class="text-blue-700" id="roundDescription">Pick your team for this round's matches</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-900" id="userScore">0</div>
                                <div class="text-sm text-blue-700">Rounds Survived</div>
                            </div>
                        </div>
                    </div>

                    <div id="teamSelection" class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Select Your Team</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" id="teamGrid">
                            <!-- Teams will be populated by JavaScript -->
                        </div>
                        <div class="mt-4">
                            <button id="submitPick" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
                                Submit Pick
                            </button>
                            <span id="pickStatus" class="ml-3 text-sm text-gray-600"></span>
                        </div>
                    </div>

                    <!-- Current Round View -->
                    <div id="currentRoundView">
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">This Round's Matches</h4>
                            <div id="matchesList" class="space-y-3">
                                <!-- Matches will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- All Fixtures View -->
                    <div id="allFixturesView" class="hidden">
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-gray-800">All Fixtures</h4>
                                <select id="roundSelector" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- Rounds will be populated by JavaScript -->
                                </select>
                            </div>
                            <div id="allFixturesList" class="space-y-3">
                                <!-- All fixtures will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let isLoginMode = true;
        let gameData = null;
        let selectedTeam = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing URC Fantasy League app...');
            initializeAuth();
            setupEventListeners();
            checkExistingSession();
            initializeGame();

            // Start with current round view
            switchView('currentRound');

            // Hide admin panel by default
            const adminPanel = document.querySelector('.bg-yellow-50');
            if (adminPanel) {
                adminPanel.style.display = 'none';
            }

            // Update game state every minute
            setInterval(() => {
                if (currentUser && gameData) {
                    updateGameState();
                    updateGameDisplay();
                }
            }, 60000);
        });

        // Initialize authentication system
        function initializeAuth() {
            switchAuthMode('login');
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('loginTab').addEventListener('click', () => switchAuthMode('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthMode('register'));

            // Form submission
            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Game events
            document.getElementById('submitPick').addEventListener('click', submitTeamPick);

            // View toggle
            document.getElementById('currentRoundTab').addEventListener('click', () => switchView('currentRound'));
            document.getElementById('allFixturesTab').addEventListener('click', () => switchView('allFixtures'));
            document.getElementById('roundSelector').addEventListener('change', updateAllFixturesView);

            // Admin controls
            document.getElementById('advanceRoundBtn').addEventListener('click', advanceRoundManually);
            document.getElementById('simulateResultsBtn').addEventListener('click', simulateMatchResults);
            document.getElementById('resetGameBtn').addEventListener('click', resetGameData);
            document.getElementById('toggleAdminBtn').addEventListener('click', toggleAdminPanel);
            document.getElementById('finalizeAllBtn').addEventListener('click', finalizeAllPendingMatches);
        }

        // Switch between login and register modes
        function switchAuthMode(mode) {
            isLoginMode = mode === 'login';
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const displayNameField = document.getElementById('displayNameField');
            const buttonText = document.getElementById('buttonText');

            if (isLoginMode) {
                loginTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium';
                registerTab.className = 'flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200';
                displayNameField.classList.add('hidden');
                buttonText.textContent = 'Login';
            } else {
                loginTab.className = 'flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200';
                registerTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium';
                displayNameField.classList.remove('hidden');
                buttonText.textContent = 'Register';
            }
            clearForm();
        }

        function clearForm() {
            document.getElementById('authForm').reset();
            clearErrors();
        }

        function clearErrors() {
            // Clear any error messages
            const errors = document.querySelectorAll('[id$="Error"]');
            errors.forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
        }

        // Handle form submission
        function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('displayName')?.value?.trim() || '';

            if (isLoginMode) {
                loginUser(email, password);
            } else {
                registerUser(email, password, displayName);
            }
        }

        // Login user
        function loginUser(email, password) {
            const users = getStoredUsers();
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());

            if (!user) {
                showNotification('No account found with this email address', 'error');
                return;
            }

            if (user.password !== hashPassword(password)) {
                showNotification('Incorrect password', 'error');
                return;
            }

            currentUser = {
                id: user.id,
                email: user.email,
                displayName: user.displayName,
                createdAt: user.createdAt
            };

            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
            showNotification('Login successful!', 'success');
        }

        // Register user
        function registerUser(email, password, displayName) {
            const users = getStoredUsers();

            if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
                showNotification('An account with this email already exists', 'error');
                return;
            }

            const newUser = {
                id: 'user_' + Date.now(),
                email: email.toLowerCase(),
                password: hashPassword(password),
                displayName: displayName,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            currentUser = {
                id: newUser.id,
                email: newUser.email,
                displayName: newUser.displayName,
                createdAt: newUser.createdAt
            };

            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
            showNotification('Registration successful! Welcome to URC Fantasy League!', 'success');
        }

        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.displayName;
            loadGameData();
        }

        function logout() {
            currentUser = null;
            selectedTeam = null;
            localStorage.removeItem('currentUser');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            showNotification('Logged out successfully', 'info');
        }

        function getStoredUsers() {
            const users = localStorage.getItem('users');
            return users ? JSON.parse(users) : [];
        }

        function hashPassword(password) {
            // Simple hash function for demo purposes
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Get fixtures data
        function getFixturesData() {
            return [
                // Round 1 - September 2025
                { round: 1, home: 'stormers', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2025-09-26', time: '18:00' },
                { round: 1, home: 'glasgow', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2025-09-26', time: '20:05' },
                { round: 1, home: 'ulster', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2025-09-26', time: '20:05' },
                { round: 1, home: 'bulls', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2025-09-27', time: '13:00' },
                { round: 1, home: 'zebre', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2025-09-27', time: '15:05' },
                { round: 1, home: 'scarlets', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2025-09-27', time: '17:30' },
                { round: 1, home: 'cardiff', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2025-09-27', time: '19:45' },
                { round: 1, home: 'connacht', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2025-09-27', time: '19:45' },

                // Round 2 - October 2025
                { round: 2, home: 'stormers', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2025-10-03', time: '18:00' },
                { round: 2, home: 'dragons', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2025-10-03', time: '20:05' },
                { round: 2, home: 'edinburgh', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2025-10-03', time: '20:05' },
                { round: 2, home: 'connacht', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2025-10-04', time: '13:45' },
                { round: 2, home: 'benetton', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2025-10-04', time: '17:30' },
                { round: 2, home: 'bulls', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2025-10-04', time: '17:30' },
                { round: 2, home: 'munster', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2025-10-04', time: '19:45' },
                { round: 2, home: 'zebre', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2025-10-05', time: '15:00' },

                // Round 3 - October 2025
                { round: 3, home: 'munster', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2025-10-10', time: '19:45' },
                { round: 3, home: 'scarlets', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2025-10-10', time: '19:45' },
                { round: 3, home: 'benetton', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '15:00' },
                { round: 3, home: 'ospreys', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '15:00' },
                { round: 3, home: 'glasgow', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '17:30' },
                { round: 3, home: 'leinster', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '17:30' },
                { round: 3, home: 'cardiff', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '19:45' },
                { round: 3, home: 'ulster', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2025-10-11', time: '19:45' },

                // Round 4 - October 2025
                { round: 4, home: 'connacht', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2025-10-17', time: '19:45' },
                { round: 4, home: 'dragons', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2025-10-17', time: '19:45' },
                { round: 4, home: 'edinburgh', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2025-10-17', time: '19:45' },
                { round: 4, home: 'lions', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2025-10-18', time: '12:45' },
                { round: 4, home: 'sharks', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2025-10-18', time: '15:00' },
                { round: 4, home: 'leinster', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2025-10-18', time: '17:15' },
                { round: 4, home: 'ospreys', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2025-10-18', time: '19:45' },
                { round: 4, home: 'zebre', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2025-10-18', time: '19:45' },

                // Round 5 - October 2025
                { round: 5, home: 'glasgow', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2025-10-24', time: '19:45' },
                { round: 5, home: 'lions', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '12:45' },
                { round: 5, home: 'sharks', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '15:00' },
                { round: 5, home: 'benetton', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '17:30' },
                { round: 5, home: 'dragons', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '17:30' },
                { round: 5, home: 'leinster', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '17:30' },
                { round: 5, home: 'cardiff', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '19:45' },
                { round: 5, home: 'munster', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2025-10-25', time: '19:45' },

                // Round 6 - November 2025
                { round: 6, home: 'dragons', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2025-11-28', time: '19:45' },
                { round: 6, home: 'ulster', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2025-11-28', time: '19:45' },
                { round: 6, home: 'bulls', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '12:00' },
                { round: 6, home: 'zebre', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '13:00' },
                { round: 6, home: 'edinburgh', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '17:30' },
                { round: 6, home: 'munster', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '17:30' },
                { round: 6, home: 'connacht', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '19:45' },
                { round: 6, home: 'scarlets', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2025-11-29', time: '19:45' },

                // Round 7 - December 2025
                { round: 7, home: 'cardiff', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2025-12-19', time: '19:45' },
                { round: 7, home: 'leinster', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2025-12-19', time: '19:45' },
                { round: 7, home: 'stormers', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '13:30' },
                { round: 7, home: 'benetton', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '14:00' },
                { round: 7, home: 'glasgow', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '15:00' },
                { round: 7, home: 'sharks', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '16:00' },
                { round: 7, home: 'ospreys', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '17:30' },
                { round: 7, home: 'dragons', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2025-12-20', time: '19:45' },

                // Round 8 - December 2025
                { round: 8, home: 'bulls', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2025-12-26', time: '00:00' },
                { round: 8, home: 'lions', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2025-12-26', time: '00:00' },
                { round: 8, home: 'cardiff', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2025-12-26', time: '15:00' },
                { round: 8, home: 'scarlets', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2025-12-26', time: '17:30' },
                { round: 8, home: 'zebre', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2025-12-27', time: '14:30' },
                { round: 8, home: 'edinburgh', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2025-12-27', time: '15:00' },
                { round: 8, home: 'connacht', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2025-12-27', time: '17:30' },
                { round: 8, home: 'munster', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2025-12-27', time: '19:45' },

                // Round 9 - January 2026
                { round: 9, home: 'dragons', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2026-01-01', time: '15:00' },
                { round: 9, home: 'ospreys', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-01-01', time: '17:30' },
                { round: 9, home: 'ulster', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-01-02', time: '19:45' },
                { round: 9, home: 'sharks', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2026-01-03', time: '13:30' },
                { round: 9, home: 'stormers', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-01-03', time: '16:00' },
                { round: 9, home: 'benetton', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-01-03', time: '17:30' },
                { round: 9, home: 'leinster', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-01-03', time: '17:30' },
                { round: 9, home: 'glasgow', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-01-03', time: '19:45' },

                // Round 10 - January 2026
                { round: 10, home: 'edinburgh', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-01-23', time: '19:45' },
                { round: 10, home: 'munster', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-01-23', time: '19:45' },
                { round: 10, home: 'ospreys', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2026-01-23', time: '19:45' },
                { round: 10, home: 'scarlets', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2026-01-24', time: '15:00' },
                { round: 10, home: 'connacht', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2026-01-24', time: '17:30' },
                { round: 10, home: 'stormers', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2026-01-24', time: '17:30' },
                { round: 10, home: 'cardiff', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2026-01-24', time: '19:45' },
                { round: 10, home: 'zebre', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-01-24', time: '19:45' },

                // Round 11 - January 2026
                { round: 11, home: 'benetton', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2026-01-30', time: '19:45' },
                { round: 11, home: 'glasgow', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-01-30', time: '19:45' },
                { round: 11, home: 'lions', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '12:30' },
                { round: 11, home: 'sharks', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '15:00' },
                { round: 11, home: 'zebre', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '15:00' },
                { round: 11, home: 'leinster', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '17:30' },
                { round: 11, home: 'ospreys', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '19:45' },
                { round: 11, home: 'ulster', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-01-31', time: '19:45' },

                // Round 12 - February 2026
                { round: 12, home: 'cardiff', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2026-02-27', time: '19:45' },
                { round: 12, home: 'edinburgh', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2026-02-27', time: '19:45' },
                { round: 12, home: 'lions', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '12:30' },
                { round: 12, home: 'bulls', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '15:00' },
                { round: 12, home: 'connacht', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '15:00' },
                { round: 12, home: 'dragons', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '17:30' },
                { round: 12, home: 'munster', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '17:30' },
                { round: 12, home: 'ospreys', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2026-02-28', time: '19:45' },

                // Round 13 - March 2026
                { round: 13, home: 'bulls', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-03-20', time: '17:00' },
                { round: 13, home: 'scarlets', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-03-20', time: '19:45' },
                { round: 13, home: 'ulster', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-03-20', time: '19:45' },
                { round: 13, home: 'lions', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-03-21', time: '12:45' },
                { round: 13, home: 'benetton', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2026-03-21', time: '15:00' },
                { round: 13, home: 'sharks', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-03-21', time: '15:00' },
                { round: 13, home: 'glasgow', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2026-03-21', time: '17:30' },
                { round: 13, home: 'stormers', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-03-21', time: '17:30' },

                // Round 14 - March 2026
                { round: 14, home: 'sharks', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-03-27', time: '17:00' },
                { round: 14, home: 'glasgow', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2026-03-27', time: '19:45' },
                { round: 14, home: 'bulls', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '12:00' },
                { round: 14, home: 'connacht', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '14:15' },
                { round: 14, home: 'lions', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '14:30' },
                { round: 14, home: 'stormers', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '17:00' },
                { round: 14, home: 'leinster', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '17:30' },
                { round: 14, home: 'zebre', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2026-03-28', time: '19:45' },

                // Round 15 - April 2026
                { round: 15, home: 'dragons', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-04-17', time: '19:45' },
                { round: 15, home: 'edinburgh', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-04-17', time: '19:45' },
                { round: 15, home: 'ulster', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2026-04-17', time: '19:45' },
                { round: 15, home: 'lions', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-04-18', time: '14:45' },
                { round: 15, home: 'stormers', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-04-18', time: '17:15' },
                { round: 15, home: 'scarlets', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-04-18', time: '17:30' },
                { round: 15, home: 'benetton', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-04-18', time: '19:45' },
                { round: 15, home: 'ospreys', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2026-04-18', time: '19:45' },

                // Round 16 - April 2026
                { round: 16, home: 'cardiff', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2026-04-24', time: '19:45' },
                { round: 16, home: 'edinburgh', away: 'sharks', homeScore: null, awayScore: null, completed: false, date: '2026-04-24', time: '19:45' },
                { round: 16, home: 'zebre', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-04-24', time: '19:45' },
                { round: 16, home: 'lions', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-04-25', time: '15:00' },
                { round: 16, home: 'munster', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2026-04-25', time: '17:30' },
                { round: 16, home: 'stormers', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-04-25', time: '17:30' },
                { round: 16, home: 'benetton', away: 'leinster', homeScore: null, awayScore: null, completed: false, date: '2026-04-25', time: '19:45' },
                { round: 16, home: 'scarlets', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-04-25', time: '19:45' },

                // Round 17 - May 2026
                { round: 17, home: 'glasgow', away: 'cardiff', homeScore: null, awayScore: null, completed: false, date: '2026-05-08', time: '19:45' },
                { round: 17, home: 'ulster', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2026-05-08', time: '19:45' },
                { round: 17, home: 'bulls', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '12:45' },
                { round: 17, home: 'sharks', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '15:00' },
                { round: 17, home: 'leinster', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '17:30' },
                { round: 17, home: 'ospreys', away: 'scarlets', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '17:30' },
                { round: 17, home: 'connacht', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '19:45' },
                { round: 17, home: 'dragons', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-05-09', time: '19:45' },

                // Round 18 - May 2026
                { round: 18, home: 'cardiff', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2026-05-15', time: '19:45' },
                { round: 18, home: 'edinburgh', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-05-15', time: '19:45' },
                { round: 18, home: 'ulster', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-05-15', time: '19:45' },
                { round: 18, home: 'sharks', away: 'zebre', homeScore: null, awayScore: null, completed: false, date: '2026-05-16', time: '12:45' },
                { round: 18, home: 'bulls', away: 'benetton', homeScore: null, awayScore: null, completed: false, date: '2026-05-16', time: '15:00' },
                { round: 18, home: 'leinster', away: 'ospreys', homeScore: null, awayScore: null, completed: false, date: '2026-05-16', time: '17:15' },
                { round: 18, home: 'scarlets', away: 'dragons', homeScore: null, awayScore: null, completed: false, date: '2026-05-16', time: '17:15' },
                { round: 18, home: 'munster', away: 'lions', homeScore: null, awayScore: null, completed: false, date: '2026-05-16', time: '19:45' }
            ];
        }

        // Game functionality
        function initializeGame() {
            try {
                if (!localStorage.getItem('gameData')) {
                    initializeGameData();
                }
                gameData = JSON.parse(localStorage.getItem('gameData'));
                console.log('Game initialized');
            } catch (error) {
                console.error('Error initializing game:', error);
                initializeGameData();
                gameData = JSON.parse(localStorage.getItem('gameData'));
            }
        }

        function initializeGameData() {
            const teams = [
                { id: 'leinster', name: 'Leinster', country: 'Ireland' },
                { id: 'munster', name: 'Munster', country: 'Ireland' },
                { id: 'ulster', name: 'Ulster', country: 'Ireland' },
                { id: 'connacht', name: 'Connacht', country: 'Ireland' },
                { id: 'glasgow', name: 'Glasgow Warriors', country: 'Scotland' },
                { id: 'edinburgh', name: 'Edinburgh', country: 'Scotland' },
                { id: 'cardiff', name: 'Cardiff Rugby', country: 'Wales' },
                { id: 'ospreys', name: 'Ospreys', country: 'Wales' },
                { id: 'scarlets', name: 'Scarlets', country: 'Wales' },
                { id: 'dragons', name: 'Dragons', country: 'Wales' },
                { id: 'bulls', name: 'Bulls', country: 'South Africa' },
                { id: 'stormers', name: 'Stormers', country: 'South Africa' },
                { id: 'sharks', name: 'Sharks', country: 'South Africa' },
                { id: 'lions', name: 'Lions', country: 'South Africa' },
                { id: 'zebre', name: 'Zebre Parma', country: 'Italy' },
                { id: 'benetton', name: 'Benetton', country: 'Italy' }
            ];

            const fixtures = getFixturesData();

            // Add knockout fixtures to regular season fixtures
            const allFixtures = [...fixtures, ...generateKnockoutFixtures()];

            const gameData = {
                currentRound: 1,
                teams: teams,
                fixtures: allFixtures,
                userPicks: {},
                eliminatedUsers: {},
                gameState: 'picking',
                seasonPhase: 'regular'
            };

            localStorage.setItem('gameData', JSON.stringify(gameData));
        }

        function loadGameData() {
            if (!currentUser) return;
            gameData = JSON.parse(localStorage.getItem('gameData'));
            updateGameDisplay();
        }

        // Switch between current round and all fixtures views
        function switchView(view) {
            const currentRoundTab = document.getElementById('currentRoundTab');
            const allFixturesTab = document.getElementById('allFixturesTab');
            const currentRoundView = document.getElementById('currentRoundView');
            const allFixturesView = document.getElementById('allFixturesView');

            if (view === 'currentRound') {
                currentRoundTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium';
                allFixturesTab.className = 'flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200';
                currentRoundView.classList.remove('hidden');
                allFixturesView.classList.add('hidden');
                updateMatchesList();
            } else {
                currentRoundTab.className = 'flex-1 py-2 px-4 text-gray-600 rounded-md font-medium hover:bg-gray-200';
                allFixturesTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-md font-medium';
                currentRoundView.classList.add('hidden');
                allFixturesView.classList.remove('hidden');
                populateRoundSelector();
                updateAllFixturesView();
            }
        }

        // Populate round selector dropdown
        function populateRoundSelector() {
            const roundSelector = document.getElementById('roundSelector');
            roundSelector.innerHTML = '';

            // Get all unique rounds from fixtures
            const rounds = [...new Set(gameData.fixtures.map(f => f.round))].sort((a, b) => a - b);

            rounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round;
                option.textContent = getRoundName(round);
                if (round === gameData.currentRound) {
                    option.selected = true;
                }
                roundSelector.appendChild(option);
            });
        }

        // Update all fixtures view for selected round
        function updateAllFixturesView() {
            const roundSelector = document.getElementById('roundSelector');
            const selectedRound = parseInt(roundSelector.value);

            const allFixturesList = document.getElementById('allFixturesList');
            allFixturesList.innerHTML = '';

            const roundFixtures = gameData.fixtures.filter(f => f.round === selectedRound);

            if (roundFixtures.length === 0) {
                allFixturesList.innerHTML = '<p class="text-gray-600">No fixtures found for this round.</p>';
                return;
            }

            roundFixtures.forEach(fixture => {
                const homeTeam = gameData.teams.find(t => t.id === fixture.home);
                const awayTeam = gameData.teams.find(t => t.id === fixture.away);
                const dateTimeInfo = formatDateTime(fixture.date, fixture.time);

                const fixtureDiv = document.createElement('div');
                fixtureDiv.className = `bg-gray-50 rounded-lg p-4 ${fixture.completed ? 'bg-green-50' : ''}`;

                let scoreDisplay = '';
                let winnerButtons = '';
                let finalizeButton = '';

                if (!fixture.completed) {
                    // Show winner selection buttons
                    winnerButtons = `
                        <div class="mt-3 flex gap-2">
                            <button onclick="setWinner('${fixture.home}', '${fixture.away}', ${selectedRound})"
                                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                ${homeTeam.name} Win
                            </button>
                            <button onclick="setDraw('${fixture.home}', '${fixture.away}', ${selectedRound})"
                                    class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">
                                Draw
                            </button>
                            <button onclick="setWinner('${fixture.away}', '${fixture.home}', ${selectedRound})"
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                ${awayTeam.name} Win
                            </button>
                        </div>
                    `;

                    finalizeButton = `
                        <div class="mt-3">
                            <button onclick="finalizeMatch('${fixture.home}', '${fixture.away}', ${selectedRound})"
                                    class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-medium">
                                Finalize Match
                            </button>
                        </div>
                    `;
                } else {
                    // Show final result
                    scoreDisplay = `<span class="text-lg font-bold text-green-600">(${fixture.homeScore} - ${fixture.awayScore})</span>`;
                }

                let statusText = '';
                if (fixture.completed) {
                    statusText = '<span class="text-green-600 text-sm">‚úì Completed</span>';
                } else if (dateTimeInfo.isPast) {
                    statusText = '<span class="text-red-600 text-sm">Live/Missing Result</span>';
                } else if (dateTimeInfo.isToday) {
                    statusText = '<span class="text-blue-600 text-sm">Today</span>';
                } else if (dateTimeInfo.isTomorrow) {
                    statusText = '<span class="text-orange-600 text-sm">Tomorrow</span>';
                }

                fixtureDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <div class="font-semibold text-lg">${homeTeam.name} vs ${awayTeam.name}</div>
                                ${statusText}
                            </div>
                            <div class="text-sm text-gray-600 mb-2">${dateTimeInfo.formatted}</div>
                            ${scoreDisplay}
                            ${winnerButtons}
                            ${finalizeButton}
                        </div>
                    </div>
                `;

                allFixturesList.appendChild(fixtureDiv);
            });
        }

        // Set winner for a match
        function setWinner(winner, loser, round) {
            // Find and update the fixture
            const fixture = gameData.fixtures.find(f =>
                f.round === round &&
                ((f.home === winner && f.away === loser) || (f.home === loser && f.away === winner))
            );

            if (!fixture) return;

            if (fixture.home === winner) {
                fixture.homeScore = Math.floor(Math.random() * 15) + 20; // 20-35 points for winner
                fixture.awayScore = Math.floor(Math.random() * 10) + 5;  // 5-15 points for loser
            } else {
                fixture.homeScore = Math.floor(Math.random() * 10) + 5;  // 5-15 points for loser
                fixture.awayScore = Math.floor(Math.random() * 15) + 20; // 20-35 points for winner
            }

            // Store the pending result
            fixture.pendingResult = true;
            localStorage.setItem('gameData', JSON.stringify(gameData));

            showNotification(`Set ${gameData.teams.find(t => t.id === winner).name} as winner`, 'success');
            updateAllFixturesView();
        }

        // Set draw result
        function setDraw(home, away, round) {
            const fixture = gameData.fixtures.find(f =>
                f.round === round &&
                f.home === home && f.away === away
            );

            if (!fixture) return;

            fixture.homeScore = Math.floor(Math.random() * 10) + 15; // 15-25 points each
            fixture.awayScore = Math.floor(Math.random() * 10) + 15; // 15-25 points each

            // Store the pending result
            fixture.pendingResult = true;
            localStorage.setItem('gameData', JSON.stringify(gameData));

            showNotification('Set match as a draw', 'success');
            updateAllFixturesView();
        }

        // Finalize a match result
        function finalizeMatch(home, away, round) {
            const fixture = gameData.fixtures.find(f =>
                f.round === round &&
                f.home === home && f.away === away
            );

            if (!fixture || !fixture.pendingResult) {
                showNotification('No pending result to finalize', 'warning');
                return;
            }

            // Mark as completed
            fixture.completed = true;
            delete fixture.pendingResult;

            // Process user eliminations based on this result
            processUserEliminations(round);

            localStorage.setItem('gameData', JSON.stringify(gameData));

            showNotification('Match finalized! User eliminations processed.', 'success');
            updateGameDisplay();
            updateAllFixturesView();
        }

        // Process user eliminations for a round
        function processUserEliminations(round) {
            const users = getStoredUsers();

            users.forEach(user => {
                const userPick = gameData.userPicks[user.id]?.[round];
                if (!userPick) return;

                const userPickedTeam = userPick;
                const roundFixtures = gameData.fixtures.filter(f => f.round === round);

                // Check if user's team won or drew
                let userSurvived = false;
                for (const fixture of roundFixtures) {
                    if (fixture.home === userPickedTeam || fixture.away === userPickedTeam) {
                        if (fixture.completed) {
                            if (fixture.home === userPickedTeam && fixture.homeScore >= fixture.awayScore) {
                                userSurvived = true; // Win or draw
                            } else if (fixture.away === userPickedTeam && fixture.awayScore >= fixture.homeScore) {
                                userSurvived = true; // Win or draw
                            } else {
                                userSurvived = false; // Loss
                            }
                        }
                        break;
                    }
                }

                // If user didn't survive, mark them as eliminated
                if (!userSurvived) {
                    if (!gameData.eliminatedUsers[user.id]) {
                        gameData.eliminatedUsers[user.id] = round;
                    }
                }
            });
        }

        function updateGameDisplay() {
            updateCurrentRound();
            updateTeamSelection();
            updateMatchesList();
            updateLeaderboard();
            updateUserScore();
        }

        function updateCurrentRound() {
            const roundName = getRoundName(gameData.currentRound);
            document.getElementById('currentRoundDisplay').textContent = roundName;

            const description = gameData.seasonPhase === 'regular'
                ? `Pick your team for this round's matches`
                : `Pick your team for the ${roundName}`;
            document.getElementById('roundDescription').textContent = description;
        }

        function updateTeamSelection() {
            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';

            const userPicks = gameData.userPicks[currentUser.id] || {};
            const eliminatedUsers = gameData.eliminatedUsers || {};

            gameData.teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = 'bg-gray-100 rounded-lg p-3 text-center cursor-pointer hover:bg-gray-200 transition-colors team-card';
                teamCard.dataset.teamId = team.id;

                // Check if team was already picked by this user in current round
                const alreadyPicked = userPicks[gameData.currentRound] === team.id;

                // Check if user is eliminated
                const userEliminated = eliminatedUsers[currentUser.id];

                // In knockout rounds, teams are only available if they won their previous match
                let teamAvailable = !alreadyPicked && !userEliminated;

                if (gameData.seasonPhase === 'knockout') {
                    // For knockout rounds, teams are only available if they won the previous round
                    const previousRound = gameData.currentRound - 1;
                    const previousRoundFixtures = gameData.fixtures.filter(f => f.round === previousRound);

                    // Find if this team won in the previous round
                    let teamWonPrevious = true; // Assume available if no previous round
                    for (const fixture of previousRoundFixtures) {
                        if (fixture.home === team.id || fixture.away === team.id) {
                            if (fixture.completed) {
                                if (fixture.home === team.id && fixture.homeScore <= fixture.awayScore) {
                                    teamWonPrevious = false; // Lost
                                } else if (fixture.away === team.id && fixture.awayScore <= fixture.homeScore) {
                                    teamWonPrevious = false; // Lost
                                }
                            } else {
                                teamWonPrevious = false; // Match not completed yet
                            }
                            break;
                        }
                    }
                    teamAvailable = teamAvailable && teamWonPrevious;
                }

                let statusText = '';
                let statusClass = '';

                if (alreadyPicked) {
                    statusText = 'Already Picked';
                    statusClass = 'text-red-600';
                    teamCard.className = 'bg-red-100 rounded-lg p-3 text-center cursor-not-allowed opacity-60';
                } else if (userEliminated) {
                    statusText = 'Eliminated';
                    statusClass = 'text-red-600';
                    teamCard.className = 'bg-red-100 rounded-lg p-3 text-center cursor-not-allowed opacity-60';
                } else if (gameData.seasonPhase === 'knockout' && !teamAvailable) {
                    statusText = 'Eliminated';
                    statusClass = 'text-red-600';
                    teamCard.className = 'bg-red-100 rounded-lg p-3 text-center cursor-not-allowed opacity-60';
                } else {
                    teamCard.className = 'bg-gray-100 rounded-lg p-3 text-center cursor-pointer hover:bg-gray-200 transition-colors team-card';
                }

                // Check if this team is currently selected (for visual feedback)
                const isSelected = selectedTeam === team.id;

                teamCard.innerHTML = `
                    <div class="font-semibold text-gray-800">${team.name}</div>
                    <div class="text-sm text-gray-600">${team.country}</div>
                    ${statusText ? `<div class="text-xs ${statusClass} mt-1">${statusText}</div>` : ''}
                `;

                // Add green background if team is selected and available
                if (isSelected && teamAvailable && !alreadyPicked && !userEliminated) {
                    teamCard.className = 'bg-green-200 border-2 border-green-500 rounded-lg p-3 text-center cursor-pointer hover:bg-green-300 transition-colors team-card';
                }

                // Only add click event if team is available
                if (teamAvailable) {
                    teamCard.addEventListener('click', () => selectTeam(team.id));
                }

                teamGrid.appendChild(teamCard);
            });
        }

        function selectTeam(teamId) {
            // Check if team is available (not already picked, user not eliminated, etc.)
            const userPicks = gameData.userPicks[currentUser.id] || {};
            const eliminatedUsers = gameData.eliminatedUsers || {};
            const alreadyPicked = Object.values(userPicks).includes(teamId);
            const userEliminated = eliminatedUsers[currentUser.id];

            if (alreadyPicked || userEliminated) {
                showNotification('This team is not available for selection', 'warning');
                return;
            }

            // In knockout rounds, check if team won previous round
            if (gameData.seasonPhase === 'knockout') {
                const previousRound = gameData.currentRound - 1;
                const previousRoundFixtures = gameData.fixtures.filter(f => f.round === previousRound);
                let teamWonPrevious = true;

                for (const fixture of previousRoundFixtures) {
                    if (fixture.home === teamId || fixture.away === teamId) {
                        if (fixture.completed) {
                            if (fixture.home === teamId && fixture.homeScore <= fixture.awayScore) {
                                teamWonPrevious = false;
                            } else if (fixture.away === teamId && fixture.awayScore <= fixture.homeScore) {
                                teamWonPrevious = false;
                            }
                        } else {
                            teamWonPrevious = false;
                        }
                        break;
                    }
                }

                if (!teamWonPrevious) {
                    showNotification('This team did not advance from the previous round', 'warning');
                    return;
                }
            }

            // Remove previous selection (remove green styling from all cards)
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('bg-green-200', 'border-green-500', 'bg-blue-200', 'border-blue-500');
                card.classList.add('bg-gray-100');
            });

            // Add green selection to current team
            const selectedCard = document.querySelector(`[data-team-id="${teamId}"]`);
            selectedCard.classList.remove('bg-gray-100');
            selectedCard.classList.add('bg-green-200', 'border-2', 'border-green-500');

            selectedTeam = teamId;
            document.getElementById('submitPick').disabled = false;
            document.getElementById('pickStatus').textContent = `Selected: ${gameData.teams.find(t => t.id === teamId).name}`;
        }

        function submitTeamPick() {
            if (!selectedTeam) {
                showNotification('Please select a team first', 'error');
                return;
            }

            try {
                // Store user's pick
                if (!gameData.userPicks[currentUser.id]) {
                    gameData.userPicks[currentUser.id] = {};
                }

                gameData.userPicks[currentUser.id][gameData.currentRound] = selectedTeam;
                localStorage.setItem('gameData', JSON.stringify(gameData));

                showNotification(`Pick submitted: ${gameData.teams.find(t => t.id === selectedTeam).name}`, 'success');

                // Keep the green styling after successful submission
                const selectedCard = document.querySelector(`[data-team-id="${selectedTeam}"]`);
                if (selectedCard) {
                    selectedCard.className = 'bg-green-300 border-2 border-green-600 rounded-lg p-3 text-center cursor-pointer hover:bg-green-400 transition-colors team-card';
                }

                // Update display (but don't clear the selection since we want to keep it green)
                updateGameDisplay();
            } catch (error) {
                console.error('Error submitting pick:', error);
                showNotification('Error submitting your pick. Please try again.', 'error');
            }
        }

        function updateMatchesList() {
            const matchesList = document.getElementById('matchesList');
            matchesList.innerHTML = '';

            const currentRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound);

            if (currentRoundFixtures.length === 0) {
                matchesList.innerHTML = '<p class="text-gray-600">No matches scheduled for this round yet.</p>';
                return;
            }

            currentRoundFixtures.forEach(fixture => {
                const homeTeam = gameData.teams.find(t => t.id === fixture.home);
                const awayTeam = gameData.teams.find(t => t.id === fixture.away);
                const dateTimeInfo = formatDateTime(fixture.date, fixture.time);

                const matchDiv = document.createElement('div');
                matchDiv.className = `bg-gray-50 rounded-lg p-3 ${fixture.completed ? 'bg-green-50' : ''}`;

                let scoreDisplay = '';
                if (fixture.completed && fixture.homeScore !== null && fixture.awayScore !== null) {
                    scoreDisplay = `<span class="text-lg font-bold text-green-600">(${fixture.homeScore} - ${fixture.awayScore})</span>`;
                }

                let statusText = '';
                if (fixture.completed) {
                    statusText = '<span class="text-green-600 text-sm">‚úì Completed</span>';
                } else if (dateTimeInfo.isPast) {
                    statusText = '<span class="text-red-600 text-sm">Live/Missing Result</span>';
                } else if (dateTimeInfo.isToday) {
                    statusText = '<span class="text-blue-600 text-sm">Today</span>';
                } else if (dateTimeInfo.isTomorrow) {
                    statusText = '<span class="text-orange-600 text-sm">Tomorrow</span>';
                }

                matchDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 text-right">
                            <div class="font-semibold">${homeTeam.name}</div>
                            <div class="text-sm text-gray-600">${dateTimeInfo.formatted}</div>
                        </div>
                        <div class="px-4 text-center">
                            <div class="text-2xl font-bold">vs</div>
                            ${scoreDisplay}
                            ${statusText}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold">${awayTeam.name}</div>
                        </div>
                    </div>
                `;
                matchesList.appendChild(matchDiv);
            });
        }

        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '';

            const users = getStoredUsers();
            const userScores = users.map(user => {
                const picks = gameData.userPicks[user.id] || {};
                let roundsSurvived = 0;

                for (let round = 1; round <= gameData.currentRound; round++) {
                    if (picks[round]) {
                        roundsSurvived++;
                    } else {
                        break;
                    }
                }

                const eliminatedRound = gameData.eliminatedUsers?.[user.id] || null;
                const stillIn = !eliminatedRound && roundsSurvived >= gameData.currentRound;

                return {
                    user: user,
                    roundsSurvived: roundsSurvived,
                    stillIn: stillIn,
                    eliminatedRound: eliminatedRound
                };
            });

            // Separate into still playing and eliminated
            const stillPlaying = userScores.filter(entry => entry.stillIn);
            const eliminated = userScores.filter(entry => !entry.stillIn);

            // Sort still playing alphabetically by display name
            stillPlaying.sort((a, b) => a.user.displayName.localeCompare(b.user.displayName));

            // Sort eliminated by elimination round (ascending), then alphabetically by display name
            eliminated.sort((a, b) => {
                if (a.eliminatedRound !== b.eliminatedRound) {
                    return (a.eliminatedRound || 999) - (b.eliminatedRound || 999);
                }
                return a.user.displayName.localeCompare(b.user.displayName);
            });

            // Add "Still Standing" section
            if (stillPlaying.length > 0) {
                const standingHeader = document.createElement('div');
                standingHeader.className = 'mb-4';
                standingHeader.innerHTML = `
                    <h5 class="text-lg font-semibold text-green-700 mb-2">Still Standing</h5>
                    <div class="text-sm text-gray-600 mb-3">${stillPlaying.length} player${stillPlaying.length !== 1 ? 's' : ''} remaining</div>
                `;
                leaderboard.appendChild(standingHeader);

                stillPlaying.forEach((entry, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex justify-between items-center p-3 rounded-lg bg-green-50 mb-2';

                    playerDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold mr-3">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold">${entry.user.displayName}</div>
                                <div class="text-sm text-green-600">Still in the game</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg">${entry.roundsSurvived}</div>
                            <div class="text-sm text-gray-600">rounds survived</div>
                        </div>
                    `;

                    leaderboard.appendChild(playerDiv);
                });
            }

            // Add "Eliminated" section
            if (eliminated.length > 0) {
                const eliminatedHeader = document.createElement('div');
                eliminatedHeader.className = 'mb-4 mt-6';
                eliminatedHeader.innerHTML = `
                    <h5 class="text-lg font-semibold text-red-700 mb-2">Eliminated</h5>
                    <div class="text-sm text-gray-600 mb-3">${eliminated.length} player${eliminated.length !== 1 ? 's' : ''} eliminated</div>
                `;
                leaderboard.appendChild(eliminatedHeader);

                eliminated.forEach((entry, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex justify-between items-center p-3 rounded-lg bg-red-50 mb-2';

                    playerDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold mr-3">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold">${entry.user.displayName}</div>
                                <div class="text-sm text-red-600">Eliminated in Round ${entry.eliminatedRound || 'Unknown'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg">${entry.roundsSurvived}</div>
                            <div class="text-sm text-gray-600">rounds survived</div>
                        </div>
                    `;

                    leaderboard.appendChild(playerDiv);
                });
            }

            // If no players, show message
            if (stillPlaying.length === 0 && eliminated.length === 0) {
                const noPlayersDiv = document.createElement('div');
                noPlayersDiv.className = 'text-center text-gray-500 py-8';
                noPlayersDiv.textContent = 'No players yet. Register and start playing!';
                leaderboard.appendChild(noPlayersDiv);
            }
        }

        function updateUserScore() {
            if (!currentUser || !gameData.userPicks[currentUser.id]) return;

            const picks = gameData.userPicks[currentUser.id];
            let roundsSurvived = 0;

            for (let round = 1; round <= gameData.currentRound; round++) {
                if (picks[round]) {
                    roundsSurvived++;
                }
            }

            document.getElementById('userScore').textContent = roundsSurvived;
        }

        function updateGameState() {
            // Check if we need to advance rounds based on current date and fixture completion
            const now = new Date();
            let shouldAdvanceRound = false;

            if (gameData.seasonPhase === 'regular') {
                const currentRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound);

                // Check if all fixtures in current round are completed
                const allCompleted = currentRoundFixtures.every(fixture => fixture.completed);

                if (allCompleted) {
                    // Check if we should advance to next round
                    const nextRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound + 1);

                    if (nextRoundFixtures.length > 0) {
                        const nextRoundStartDate = new Date(nextRoundFixtures[0].date + 'T' + nextRoundFixtures[0].time);
                        if (now >= nextRoundStartDate) {
                            shouldAdvanceRound = true;
                        }
                    } else if (gameData.currentRound >= 18) {
                        // End of regular season, move to knockout phase
                        gameData.seasonPhase = 'knockout';
                        gameData.currentRound = 19; // Quarter finals
                        shouldAdvanceRound = true;
                    }
                }
            } else if (gameData.seasonPhase === 'knockout') {
                // Handle knockout round advancement
                const currentRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound);
                const allCompleted = currentRoundFixtures.every(fixture => fixture.completed);

                if (allCompleted && gameData.currentRound < 21) {
                    gameData.currentRound++;
                    shouldAdvanceRound = true;
                }
            }

            if (shouldAdvanceRound) {
                advanceToNextRound();
            }
        }

        function advanceToNextRound() {
            const oldRound = gameData.currentRound;
            gameData.currentRound++;

            // Clear user picks for new round
            if (gameData.userPicks) {
                Object.keys(gameData.userPicks).forEach(userId => {
                    if (gameData.userPicks[userId][oldRound]) {
                        // Check if user survived the previous round
                        const userSurvived = checkIfUserSurvived(userId, oldRound);
                        if (userSurvived) {
                            // User advances, but their pick is cleared for new round
                            delete gameData.userPicks[userId][gameData.currentRound];
                        } else {
                            // User was eliminated, mark them as eliminated
                            if (!gameData.eliminatedUsers[userId]) {
                                gameData.eliminatedUsers[userId] = oldRound;
                            }
                        }
                    }
                });
            }

            localStorage.setItem('gameData', JSON.stringify(gameData));
            updateGameDisplay();
            showNotification(`Round ${oldRound} completed! Welcome to Round ${gameData.currentRound}!`, 'info');
        }

        function checkIfUserSurvived(userId, round) {
            const userPick = gameData.userPicks[userId][round];
            if (!userPick) return false;

            const roundFixtures = gameData.fixtures.filter(f => f.round === round);
            const userPickedTeam = userPick;

            // Check if user's team won or drew
            for (const fixture of roundFixtures) {
                if (fixture.home === userPickedTeam || fixture.away === userPickedTeam) {
                    if (fixture.completed) {
                        if (fixture.home === userPickedTeam && fixture.homeScore >= fixture.awayScore) {
                            return true; // Win or draw
                        } else if (fixture.away === userPickedTeam && fixture.awayScore >= fixture.homeScore) {
                            return true; // Win or draw
                        } else {
                            return false; // Loss
                        }
                    } else {
                        // Fixture not completed yet, assume user survives for now
                        return true;
                    }
                }
            }

            return true; // If team not found in fixtures, assume they survive
        }

        function formatDateTime(dateStr, timeStr) {
            try {
                const date = new Date(dateStr + 'T' + timeStr);
                return {
                    formatted: date.toLocaleDateString('en-GB', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    }) + ' ' + date.toLocaleTimeString('en-GB', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    date: date,
                    isPast: date < new Date(),
                    isToday: date.toDateString() === new Date().toDateString(),
                    isTomorrow: new Date(date.getTime() + 24 * 60 * 60 * 1000).toDateString() === new Date().toDateString(),
                    isThisWeek: date >= new Date() && date < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                };
            } catch (e) {
                return {
                    formatted: `${dateStr} ${timeStr}`,
                    date: null,
                    isPast: false,
                    isToday: false,
                    isTomorrow: false,
                    isThisWeek: false
                };
            }
        }

        function getRoundName(round) {
            if (gameData.seasonPhase === 'regular') {
                return `Round ${round}`;
            } else {
                switch (round) {
                    case 19: return 'Quarter Finals';
                    case 20: return 'Semi Finals';
                    case 21: return 'Final';
                    default: return `Round ${round}`;
                }
            }
        }

        function generateKnockoutFixtures() {
            // This would be more sophisticated in a real implementation
            // For now, we'll create placeholder fixtures for knockout rounds
            const quarterFinals = [
                { round: 19, home: 'leinster', away: 'munster', homeScore: null, awayScore: null, completed: false, date: '2026-05-29', time: '19:45' },
                { round: 19, home: 'stormers', away: 'bulls', homeScore: null, awayScore: null, completed: false, date: '2026-05-30', time: '14:00' },
                { round: 19, home: 'glasgow', away: 'edinburgh', homeScore: null, awayScore: null, completed: false, date: '2026-05-30', time: '16:30' },
                { round: 19, home: 'ulster', away: 'connacht', homeScore: null, awayScore: null, completed: false, date: '2026-05-31', time: '15:00' }
            ];

            const semiFinals = [
                { round: 20, home: 'leinster', away: 'stormers', homeScore: null, awayScore: null, completed: false, date: '2026-06-05', time: '19:45' },
                { round: 20, home: 'glasgow', away: 'ulster', homeScore: null, awayScore: null, completed: false, date: '2026-06-06', time: '16:30' }
            ];

            const final = [
                { round: 21, home: 'leinster', away: 'glasgow', homeScore: null, awayScore: null, completed: false, date: '2026-06-12', time: '19:45' }
            ];

            return [...quarterFinals, ...semiFinals, ...final];
        }

        function advanceRoundManually() {
            if (gameData.seasonPhase === 'regular') {
                const currentRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound);
                const allCompleted = currentRoundFixtures.every(fixture => fixture.completed);

                if (!allCompleted) {
                    showNotification('Cannot advance round until all matches are completed', 'warning');
                    return;
                }
            }

            const oldRound = gameData.currentRound;
            gameData.currentRound++;

            // Clear user picks for new round
            if (gameData.userPicks) {
                Object.keys(gameData.userPicks).forEach(userId => {
                    if (gameData.userPicks[userId][oldRound]) {
                        // Check if user survived the previous round
                        const userSurvived = checkIfUserSurvived(userId, oldRound);
                        if (userSurvived) {
                            // User advances, but their pick is cleared for new round
                            delete gameData.userPicks[userId][gameData.currentRound];
                        } else {
                            // User was eliminated, mark them as eliminated
                            if (!gameData.eliminatedUsers[userId]) {
                                gameData.eliminatedUsers[userId] = oldRound;
                            }
                        }
                    }
                });
            }

            localStorage.setItem('gameData', JSON.stringify(gameData));
            updateGameDisplay();
            showNotification(`Manually advanced from Round ${oldRound} to Round ${gameData.currentRound}!`, 'success');
        }

        function simulateMatchResults() {
            const currentRoundFixtures = gameData.fixtures.filter(f => f.round === gameData.currentRound && !f.completed);

            if (currentRoundFixtures.length === 0) {
                showNotification('No uncompleted matches in current round to simulate', 'warning');
                return;
            }

            currentRoundFixtures.forEach(fixture => {
                // Randomly generate scores
                fixture.homeScore = Math.floor(Math.random() * 40) + 10; // 10-50
                fixture.awayScore = Math.floor(Math.random() * 40) + 10; // 10-50
                fixture.completed = true;
            });

            localStorage.setItem('gameData', JSON.stringify(gameData));
            updateGameDisplay();
            showNotification(`Simulated results for ${currentRoundFixtures.length} matches!`, 'success');
        }

        function resetGameData() {
            if (confirm('Are you sure you want to reset the entire game? This will delete all user picks and progress.')) {
                localStorage.removeItem('gameData');
                initializeGameData();
                gameData = JSON.parse(localStorage.getItem('gameData'));
                updateGameDisplay();
                showNotification('Game has been reset! All data cleared.', 'success');
            }
        }

        function toggleAdminPanel() {
            const adminPanel = document.querySelector('.bg-yellow-50');
            const toggleBtn = document.getElementById('toggleAdminBtn');

            if (adminPanel.style.display === 'none' || adminPanel.style.display === '') {
                adminPanel.style.display = 'block';
                toggleBtn.textContent = 'Hide Admin';
                toggleBtn.className = 'bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 text-sm';
            } else {
                adminPanel.style.display = 'none';
                toggleBtn.textContent = 'Admin';
                toggleBtn.className = 'bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm';
            }
        }

        function finalizeAllPendingMatches() {
            const pendingFixtures = gameData.fixtures.filter(f => f.pendingResult && !f.completed);

            if (pendingFixtures.length === 0) {
                showNotification('No pending matches to finalize', 'warning');
                return;
            }

            pendingFixtures.forEach(fixture => {
                fixture.completed = true;
                delete fixture.pendingResult;
            });

            // Process eliminations for all affected rounds
            const affectedRounds = [...new Set(pendingFixtures.map(f => f.round))];
            affectedRounds.forEach(round => {
                processUserEliminations(round);
            });

            localStorage.setItem('gameData', JSON.stringify(gameData));

            showNotification(`Finalized ${pendingFixtures.length} matches! User eliminations processed.`, 'success');
            updateGameDisplay();
            updateAllFixturesView();
        }


        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');

            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500',
                'warning': 'bg-yellow-500'
            }[type] || 'bg-gray-500';

            notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            notification.textContent = message;

            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        console.log('Simple URC Fantasy League app loaded');
    </script>
</body>
</html>