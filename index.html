<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URC Last Man Standing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .blur-pick {
    color: transparent !important;
    text-shadow: 0 0 8px #bbb;
    background: linear-gradient(90deg, #ececec 40%, #ddd 60%);
    border-radius: 6px;
    filter: blur(6px);
    pointer-events: none;
    user-select: none;
    position: relative;
    min-width: 120px;
    min-height: 1em;
    display: inline-block;
}
.blur-pick::after {
    content: "üîí Hidden until locked";
    color: #555;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    background: rgba(255,255,255,0.85);
    padding: 2px 10px;
    border-radius: 5px;
    font-size: 0.9em;
    filter: none;
    white-space: nowrap;
}
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex">
        <!-- Chat Sidebar -->
        <div id="chatSidebar" class="fixed right-0 top-0 h-full w-80 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-40">
            <div class="flex flex-col h-full">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-800">üí¨ Chat</h3>
                    <button id="closeChatBtn" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4" id="chatMessages">
                    <div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>
                </div>
                
                <div class="p-4 border-t border-gray-200">
                    <form id="chatForm" class="flex space-x-2">
                        <input type="text" id="chatInput" placeholder="Type your message..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="200">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Send</button>
                    </form>
                    <div class="flex justify-end items-center mt-2">
                        <span class="text-xs text-gray-500" id="charCount">0/200</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Toggle Button -->
        <button id="chatToggleBtn" class="fixed right-4 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 z-30">
            üí¨
            <span id="unreadBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </button>

        <div class="container mx-auto px-4 py-8 w-full">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgMFCSXJWsbmkra95ltt9Z9LJiRuMOsIBluqwF-g4&usqp=CAE&s" alt="URC Logo" class="h-12 w-12 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                <span style="display: none;">üèâ</span>
                URC Last Man Standing
            </h1>
            <p class="text-white/80">Pick a team each week - but you can only use each team once!</p>
        </div>

        <!-- Login/Register Form -->
        <div id="authSection" class="max-w-md mx-auto bg-white rounded-xl card-shadow p-6 mb-8">
            <div class="flex mb-4">
                <button id="loginTab" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-l-lg font-medium">Login</button>
                <button id="registerTab" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-r-lg font-medium">Register</button>
            </div>
            
            <form id="authForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="6">
                    <p id="passwordHelp" class="text-xs text-gray-500 mt-1 hidden">Password must be at least 6 characters long</p>
                </div>
                

                
                <div id="nameField" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Display Name</label>
                    <input type="text" id="displayName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Profile Picture Selection -->
                <div id="profilePicField" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Profile Picture (Optional)</label>
                    
                    <!-- Upload Custom Picture -->
                    <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                        <div class="text-center">
                            <div class="mb-2">
                                <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <label for="customProfilePic" class="cursor-pointer">
                                <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Upload your picture</span>
                                <input id="customProfilePic" type="file" accept="image/*" class="hidden">
                            </label>
                            <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF up to 2MB</p>
                        </div>
                        <div id="customPicPreview" class="hidden mt-3 text-center">
                            <img id="customPicImage" class="w-16 h-16 rounded-full mx-auto object-cover border-2 border-blue-500" alt="Custom profile picture">
                            <button type="button" id="removeCustomPic" class="mt-2 text-xs text-red-600 hover:text-red-800">Remove</button>
                        </div>
                    </div>
                </div>
                
                <!-- Favorite Team Selection -->
                <div id="favoriteTeamField" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Favorite URC Team (Optional)</label>
                    <select id="favoriteTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select your favorite team</option>
                        <option value="Benetton Rugby">Benetton Rugby</option>
                        <option value="Bulls">Bulls</option>
                        <option value="Cardiff Rugby">Cardiff Rugby</option>
                        <option value="Connacht">Connacht</option>
                        <option value="Dragons">Dragons</option>
                        <option value="Edinburgh">Edinburgh</option>
                        <option value="Glasgow Warriors">Glasgow Warriors</option>
                        <option value="Leinster">Leinster</option>
                        <option value="Lions">Lions</option>
                        <option value="Munster">Munster</option>
                        <option value="Ospreys">Ospreys</option>
                        <option value="Scarlets">Scarlets</option>
                        <option value="Sharks">Sharks</option>
                        <option value="Stormers">Stormers</option>
                        <option value="Ulster">Ulster</option>
                        <option value="Zebre">Zebre</option>
                    </select>
                </div>
                
                <button type="submit" id="authButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">Login</button>
                
                <div id="forgotPasswordLink" class="text-center mt-3">
                    <button type="button" id="forgotPasswordBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">Forgot Password?</button>
                </div>
            </form>
            
            <!-- Password Reset Form -->
            <div id="passwordResetForm" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h4 class="font-medium text-gray-800 mb-3">üîê Password Reset</h4>
                <p class="text-sm text-gray-600 mb-3">Enter your email and display name to reset your password:</p>
                <div class="space-y-3">
                    <input type="email" id="resetEmail" placeholder="Your email address" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="resetDisplayName" placeholder="Your display name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="newPassword" placeholder="New password (min 6 characters)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" minlength="6">
                    <div class="flex space-x-2">
                        <button type="button" id="resetPasswordBtn" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 font-medium">Reset Password</button>
                        <button type="button" id="cancelResetBtn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 font-medium">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App (Hidden initially) -->
        <div id="mainApp" class="hidden">
            <!-- Game Mode Toggle -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex justify-center mb-4">
                    <div class="bg-gray-100 p-1 rounded-lg">
                        <button id="lmsToggle" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium transition-colors">üèâ Last Man Standing</button>
                        <button id="pickItToggle" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-200">üéØ Pick it!</button>
                    </div>
                </div>
            </div>

            <!-- User Info & Stats -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <span id="userProfilePic" class="cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(currentUser?.id)">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgMFCSXJWsbmkra95ltt9Z9LJiRuMOsIBluqwF-g4&usqp=CAE&s" class="w-8 h-8 rounded-full object-cover border border-gray-300" alt="Profile" onerror="this.src=''; this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="w-8 h-8 rounded-full bg-gray-300 border border-gray-400" style="display: none;"></div>
                        </span>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">Welcome, <span id="userName"></span>!</h2>
                            <p class="text-gray-600">Round <span id="currentRound">1</span> - September 2025</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="settingsBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Profile</button>
                        <button id="adminScores" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 hidden">Admin Panel</button>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Logout</button>
                    </div>
                </div>
                
                <!-- LMS Stats -->
                <div id="lmsStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg cursor-pointer hover:bg-green-100 transition-colors" id="standingPlayersCard">
                        <div class="text-2xl font-bold text-green-600" id="playersStanding">0</div>
                        <div class="text-sm text-green-700">Players Standing</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg cursor-pointer hover:bg-red-100 transition-colors" id="eliminatedPlayersCard">
                        <div class="text-2xl font-bold text-red-600" id="playersEliminated">0</div>
                        <div class="text-sm text-red-700">Players Eliminated</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors" id="viewPicksCard">
                        <div class="text-2xl font-bold text-blue-600" id="totalPlayers">0</div>
                        <div class="text-sm text-blue-700">View Picks</div>
                    </div>
                </div>

                <!-- Pick it! Stats -->
                <div id="pickItStats" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg cursor-pointer hover:bg-green-100 transition-colors" id="leaderboardCard">
                        <div class="text-2xl font-bold text-green-600" id="currentRank">-</div>
                        <div class="text-sm text-green-700">Current Rank</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="pickPercentage">0%</div>
                        <div class="text-sm text-green-700">Pick Accuracy</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="correctPicks">0/0</div>
                        <div class="text-sm text-green-700">Correct Picks</div>
                    </div>
                </div>
            </div>

            <!-- Round Status -->
            <div id="roundStatus" class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="text-center">
                    <div id="statusMessage" class="text-lg font-medium text-gray-800 mb-2"></div>
                    <div id="countdown" class="text-sm text-gray-600"></div>
                    <div id="roundStatusIndicator" class="mt-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                        <!-- Status will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- LMS Game Interface -->
            <div id="lmsInterface" class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div id="lmsCountdownInline" class="mb-2 text-sm text-gray-600"></div>
                <div class="flex space-x-1 mb-6">
                    <button id="currentRoundTab" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">Current Round</button>
                    <button id="fixturesTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">All Fixtures</button>
                </div>

                <!-- Current Round Section -->
                <div id="currentRoundSection">
                    <div id="currentRoundHeader" class="mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Round 1 - September 2025</h3>
                        <p class="text-gray-600">Pick your team to win this round. Remember - you can only use each team once!</p>
                    </div>
                    
                    <div id="currentRoundFixtures" class="space-y-4 mb-6">
                        <div class="mb-3">
                            <h5 class="font-medium text-gray-700 mb-2">Friday 26th September</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Stormers vs Leinster</span>
                                    <span class="text-sm text-gray-500">18:00</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Glasgow Warriors vs Sharks</span>
                                    <span class="text-sm text-gray-500">20:05</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Ulster vs Dragons</span>
                                    <span class="text-sm text-gray-500">20:05</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h5 class="font-medium text-gray-700 mb-2">Saturday 27th September</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Bulls vs Ospreys</span>
                                    <span class="text-sm text-gray-500">13:00</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Zebre vs Edinburgh</span>
                                    <span class="text-sm text-gray-500">15:05</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Scarlets vs Munster</span>
                                    <span class="text-sm text-gray-500">17:30</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Cardiff Rugby vs Lions</span>
                                    <span class="text-sm text-gray-500">19:45</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>Connacht vs Benetton Rugby</span>
                                    <span class="text-sm text-gray-500">19:45</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="font-medium text-gray-800 mb-3">Select Your Team to Win:</h4>
                    <p class="text-sm text-gray-600 mb-4">Teams you've used before are marked with ‚úó</p>
                    <div id="teamButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
                        <!-- Team buttons will be generated dynamically -->
                    </div>
                    
                    <div id="selectedTeam" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-800">Selected: <span id="selectedTeamName" class="font-semibold"></span></p>
                    </div>
                    
                    <button id="confirmPick" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Confirm Pick</button>
                </div>

                <!-- All Fixtures Section -->
                <div id="allFixturesSection" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">All URC Fixtures</h3>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Round:</label>
                            <select id="roundSelector" class="border border-gray-300 rounded px-3 py-1 text-sm">
                                <option value="all">All Rounds</option>
                                <option value="1">Round 1</option>
                                <option value="2">Round 2</option>
                                <option value="3">Round 3</option>
                                <option value="4">Round 4</option>
                                <option value="5">Round 5</option>
                                <option value="6">Round 6</option>
                                <option value="7">Round 7</option>
                                <option value="8">Round 8</option>
                                <option value="9">Round 9</option>
                                <option value="10">Round 10</option>
                                <option value="11">Round 11</option>
                                <option value="12">Round 12</option>
                                <option value="13">Round 13</option>
                                <option value="14">Round 14</option>
                                <option value="15">Round 15</option>
                                <option value="16">Round 16</option>
                                <option value="17">Semi Finals</option>
                                <option value="18">Final</option>
                            </select>
                        </div>
                    </div>
                    <div id="allFixturesContent">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Pick it! Game Interface -->
            <div id="pickItInterface" class="hidden bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex space-x-1 mb-6">
                    <button id="pickItCurrentTab" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium">Make Picks</button>
                    <button id="pickItLeaderboardTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Leaderboard</button>
                    <button id="pickItFixturesTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">All Fixtures</button>
                </div>

                <!-- Pick it! Current Round -->
                <div id="pickItCurrentSection">
                    <div class="mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Round <span id="pickItRoundNumber">1</span> - Pick All Winners</h3>
                        <p class="text-gray-600">Pick the winner for each match. You must pick all matches to save your selections!</p>
                    </div>
                    
                    <div id="pickItMatches" class="space-y-4 mb-6">
                        <!-- Pick it matches will be populated here -->
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div id="pickItProgress" class="text-sm text-gray-600">
                            Picks made: <span id="picksMade">0</span>/<span id="totalMatches">8</span>
                        </div>
                        <div id="pickItDeadline" class="text-sm text-red-600 font-medium">
                            Deadline: Friday 26th September at 17:30
                        </div>
                    </div>
                    
                    <button id="savePickItPicks" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Save All Picks</button>
                </div>

                <!-- Pick it! Leaderboard -->
                <div id="pickItLeaderboardSection" class="hidden">
                    <div class="mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">üèÜ Pick it! Leaderboard</h3>
                        <p class="text-gray-600">Rankings based on pick accuracy percentage</p>
                    </div>
                    
                    <div id="pickItLeaderboardContent" class="space-y-2">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>

                <!-- Pick it! All Fixtures -->
                <div id="pickItAllFixturesSection" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">All URC Fixtures</h3>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Round:</label>
                            <select id="pickItRoundSelector" class="border border-gray-300 rounded px-3 py-1 text-sm">
                                <option value="all">All Rounds</option>
                                <option value="1">Round 1</option>
                                <option value="2">Round 2</option>
                                <option value="3">Round 3</option>
                                <option value="4">Round 4</option>
                                <option value="5">Round 5</option>
                                <option value="6">Round 6</option>
                                <option value="7">Round 7</option>
                                <option value="8">Round 8</option>
                                <option value="9">Round 9</option>
                                <option value="10">Round 10</option>
                                <option value="11">Round 11</option>
                                <option value="12">Round 12</option>
                                <option value="13">Round 13</option>
                                <option value="14">Round 14</option>
                                <option value="15">Round 15</option>
                                <option value="16">Round 16</option>
                                <option value="17">Semi Finals</option>
                                <option value="18">Final</option>
                            </select>
                        </div>
                    </div>
                    <div id="pickItAllFixturesContent">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Players List -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Players</h3>
                    <button id="toggleEliminated" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 hidden">Show Eliminated</button>
                </div>
                
                <div id="playersList" class="space-y-2">
                    <!-- Players will be populated here -->
                </div>
            </div>

            <!-- Round Picks Status -->
            <div class="bg-white rounded-xl card-shadow p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Round <span id="picksRoundNumber">1</span> Picks Status</h3>
                <div id="picksStatusList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Picks status will be populated here -->
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="picksModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Round <span id="modalRoundNumber"></span> Picks</h3>
                            <button id="closePicksModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div id="picksContent" class="space-y-2">
                            <!-- Picks will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="playerListModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-md w-full max-h-96 overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800" id="playerListTitle">Players</h3>
                            <button id="closePlayerListModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div id="playerListContent" class="space-y-2">
                            <!-- Player names will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Player Profile</h3>
                            <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div id="profileContent">
                            <!-- Profile content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Profile Settings</h3>
                            <button id="closeSettingsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <form id="settingsForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-medium mb-2">Display Name</label>
                                <input type="text" id="settingsDisplayName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-medium mb-2">Profile Picture</label>
                                
                                <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                                    <div class="text-center">
                                        <div class="mb-2">
                                            <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </div>
                                        <label for="settingsCustomProfilePic" class="cursor-pointer">
                                            <span class="text-sm text-blue-600 hover:text-blue-500 font-medium">Upload your picture</span>
                                            <input id="settingsCustomProfilePic" type="file" accept="image/*" class="hidden">
                                        </label>
                                        <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF up to 2MB</p>
                                    </div>
                                    <div id="settingsCustomPicPreview" class="hidden mt-3 text-center">
                                        <img id="settingsCustomPicImage" class="w-16 h-16 rounded-full mx-auto object-cover border-2 border-blue-500" alt="Custom profile picture">
                                        <button type="button" id="settingsRemoveCustomPic" class="mt-2 text-xs text-red-600 hover:text-red-800">Remove</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-gray-700 text-sm font-medium mb-2">Favorite URC Team</label>
                                <select id="settingsFavoriteTeam" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select your favorite team</option>
                                    <option value="Benetton Rugby">Benetton Rugby</option>
                                    <option value="Bulls">Bulls</option>
                                    <option value="Cardiff Rugby">Cardiff Rugby</option>
                                    <option value="Connacht">Connacht</option>
                                    <option value="Dragons">Dragons</option>
                                    <option value="Edinburgh">Edinburgh</option>
                                    <option value="Glasgow Warriors">Glasgow Warriors</option>
                                    <option value="Leinster">Leinster</option>
                                    <option value="Lions">Lions</option>
                                    <option value="Munster">Munster</option>
                                    <option value="Ospreys">Ospreys</option>
                                    <option value="Scarlets">Scarlets</option>
                                    <option value="Sharks">Sharks</option>
                                    <option value="Stormers">Stormers</option>
                                    <option value="Ulster">Ulster</option>
                                    <option value="Zebre">Zebre</option>
                                </select>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">Save Changes</button>
                                <button type="button" id="cancelSettings" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 font-medium">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">üîß Admin Management Panel</h3>
                            <button id="closeAdminModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="flex space-x-1 mb-6">
                            <button id="adminScoresTab" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">Match Results</button>
                            <button id="adminPlayersTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Player Management</button>
                            <button id="adminPlayoffsTab" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Playoffs</button>
                        </div>
                        
                        <div id="adminScoresSection">
                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-800">‚ö†Ô∏è Admin only: Manually set match results. Players are only eliminated when matches are marked as FINISHED.</p>
                            </div>
                            <div class="mb-4 flex justify-between items-center">
                                <h4 class="font-semibold text-gray-800">Match Results Management</h4>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-600">Round:</label>
                                    <select id="adminRoundSelector" class="border border-gray-300 rounded px-3 py-1 text-sm">
                                        <option value="1">Round 1</option>
                                        <option value="2">Round 2</option>
                                        <option value="3">Round 3</option>
                                        <option value="4">Round 4</option>
                                        <option value="5">Round 5</option>
                                        <option value="6">Round 6</option>
                                        <option value="7">Round 7</option>
                                        <option value="8">Round 8</option>
                                        <option value="9">Round 9</option>
                                        <option value="10">Round 10</option>
                                        <option value="11">Round 11</option>
                                        <option value="12">Round 12</option>
                                        <option value="13">Round 13</option>
                                        <option value="14">Round 14</option>
                                        <option value="15">Round 15</option>
                                        <option value="16">Round 16</option>
                                        <option value="17">Semi Finals</option>
                                        <option value="18">Final</option>
                                    </select>
                                </div>
                            </div>
                            <div id="adminScoreContent" class="space-y-4">
                                <!-- Admin score forms will be populated here -->
                            </div>
                        </div>
                        
                        <div id="adminPlayersSection" class="hidden">
                            <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-sm text-red-800">‚ö†Ô∏è Danger Zone: Manually override player status and picks. Use only when system fails.</p>
                            </div>
                            <div id="adminPlayerContent" class="space-y-4">
                                <!-- Admin player forms will be populated here -->
                            </div>
                        </div>
                        
                        <div id="adminPlayoffsSection" class="hidden">
                            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-800">üèÜ Playoff Management: Set teams and times for Semi Finals and Final matches.</p>
                            </div>
                            
                            <!-- Semi Finals Setup -->
                            <div class="bg-white border rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-gray-800 mb-4">ü•Ö Semi Finals - Friday 6th June</h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="border rounded p-3">
                                        <h5 class="font-medium text-gray-700 mb-2">Semi Final 1</h5>
                                        <div class="space-y-2">
                                            <div class="flex space-x-2">
                                                <select id="sf1Home" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                    <option value="TBD">TBD</option>
                                                    <option value="Benetton Rugby">Benetton Rugby</option>
                                                    <option value="Bulls">Bulls</option>
                                                    <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                    <option value="Connacht">Connacht</option>
                                                    <option value="Dragons">Dragons</option>
                                                    <option value="Edinburgh">Edinburgh</option>
                                                    <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                    <option value="Leinster">Leinster</option>
                                                    <option value="Lions">Lions</option>
                                                    <option value="Munster">Munster</option>
                                                    <option value="Ospreys">Ospreys</option>
                                                    <option value="Scarlets">Scarlets</option>
                                                    <option value="Sharks">Sharks</option>
                                                    <option value="Stormers">Stormers</option>
                                                    <option value="Ulster">Ulster</option>
                                                    <option value="Zebre">Zebre</option>
                                                </select>
                                                <span class="text-gray-500 py-1">vs</span>
                                                <select id="sf1Away" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                    <option value="TBD">TBD</option>
                                                    <option value="Benetton Rugby">Benetton Rugby</option>
                                                    <option value="Bulls">Bulls</option>
                                                    <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                    <option value="Connacht">Connacht</option>
                                                    <option value="Dragons">Dragons</option>
                                                    <option value="Edinburgh">Edinburgh</option>
                                                    <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                    <option value="Leinster">Leinster</option>
                                                    <option value="Lions">Lions</option>
                                                    <option value="Munster">Munster</option>
                                                    <option value="Ospreys">Ospreys</option>
                                                    <option value="Scarlets">Scarlets</option>
                                                    <option value="Sharks">Sharks</option>
                                                    <option value="Stormers">Stormers</option>
                                                    <option value="Ulster">Ulster</option>
                                                    <option value="Zebre">Zebre</option>
                                                </select>
                                            </div>
                                            <input type="time" id="sf1Time" class="w-full text-sm border border-gray-300 rounded px-2 py-1" placeholder="Kick-off time">
                                        </div>
                                    </div>
                                    
                                    <div class="border rounded p-3">
                                        <h5 class="font-medium text-gray-700 mb-2">Semi Final 2</h5>
                                        <div class="space-y-2">
                                            <div class="flex space-x-2">
                                                <select id="sf2Home" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                    <option value="TBD">TBD</option>
                                                    <option value="Benetton Rugby">Benetton Rugby</option>
                                                    <option value="Bulls">Bulls</option>
                                                    <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                    <option value="Connacht">Connacht</option>
                                                    <option value="Dragons">Dragons</option>
                                                    <option value="Edinburgh">Edinburgh</option>
                                                    <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                    <option value="Leinster">Leinster</option>
                                                    <option value="Lions">Lions</option>
                                                    <option value="Munster">Munster</option>
                                                    <option value="Ospreys">Ospreys</option>
                                                    <option value="Scarlets">Scarlets</option>
                                                    <option value="Sharks">Sharks</option>
                                                    <option value="Stormers">Stormers</option>
                                                    <option value="Ulster">Ulster</option>
                                                    <option value="Zebre">Zebre</option>
                                                </select>
                                                <span class="text-gray-500 py-1">vs</span>
                                                <select id="sf2Away" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                    <option value="TBD">TBD</option>
                                                    <option value="Benetton Rugby">Benetton Rugby</option>
                                                    <option value="Bulls">Bulls</option>
                                                    <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                    <option value="Connacht">Connacht</option>
                                                    <option value="Dragons">Dragons</option>
                                                    <option value="Edinburgh">Edinburgh</option>
                                                    <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                    <option value="Leinster">Leinster</option>
                                                    <option value="Lions">Lions</option>
                                                    <option value="Munster">Munster</option>
                                                    <option value="Ospreys">Ospreys</option>
                                                    <option value="Scarlets">Scarlets</option>
                                                    <option value="Sharks">Sharks</option>
                                                    <option value="Stormers">Stormers</option>
                                                    <option value="Ulster">Ulster</option>
                                                    <option value="Zebre">Zebre</option>
                                                </select>
                                            </div>
                                            <input type="time" id="sf2Time" class="w-full text-sm border border-gray-300 rounded px-2 py-1" placeholder="Kick-off time">
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="updateSemiFinals()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Update Semi Finals</button>
                            </div>
                            
                            <!-- Final Setup -->
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-4">üèÜ Final - Friday 20th June</h4>
                                
                                <div class="border rounded p-3">
                                    <div class="space-y-2">
                                        <div class="flex space-x-2">
                                            <select id="finalHome" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                <option value="TBD">TBD</option>
                                                <option value="Benetton Rugby">Benetton Rugby</option>
                                                <option value="Bulls">Bulls</option>
                                                <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                <option value="Connacht">Connacht</option>
                                                <option value="Dragons">Dragons</option>
                                                <option value="Edinburgh">Edinburgh</option>
                                                <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                <option value="Leinster">Leinster</option>
                                                <option value="Lions">Lions</option>
                                                <option value="Munster">Munster</option>
                                                <option value="Ospreys">Ospreys</option>
                                                <option value="Scarlets">Scarlets</option>
                                                <option value="Sharks">Sharks</option>
                                                <option value="Stormers">Stormers</option>
                                                <option value="Ulster">Ulster</option>
                                                <option value="Zebre">Zebre</option>
                                            </select>
                                            <span class="text-gray-500 py-1">vs</span>
                                            <select id="finalAway" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                                <option value="TBD">TBD</option>
                                                <option value="Benetton Rugby">Benetton Rugby</option>
                                                <option value="Bulls">Bulls</option>
                                                <option value="Cardiff Rugby">Cardiff Rugby</option>
                                                <option value="Connacht">Connacht</option>
                                                <option value="Dragons">Dragons</option>
                                                <option value="Edinburgh">Edinburgh</option>
                                                <option value="Glasgow Warriors">Glasgow Warriors</option>
                                                <option value="Leinster">Leinster</option>
                                                <option value="Lions">Lions</option>
                                                <option value="Munster">Munster</option>
                                                <option value="Ospreys">Ospreys</option>
                                                <option value="Scarlets">Scarlets</option>
                                                <option value="Sharks">Sharks</option>
                                                <option value="Stormers">Stormers</option>
                                                <option value="Ulster">Ulster</option>
                                                <option value="Zebre">Zebre</option>
                                            </select>
                                        </div>
                                        <input type="time" id="finalTime" class="w-full text-sm border border-gray-300 rounded px-2 py-1" placeholder="Kick-off time">
                                    </div>
                                </div>
                                
                                <button onclick="updateFinal()" class="mt-3 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Update Final</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let currentUser = null;
        let currentGameMode = 'lms'; // 'lms' or 'pickit' - LMS is default
        let gameData = {
            players: [],
            currentRound: 1,
            roundDeadline: new Date('2025-09-26T17:30:00'),
            roundEnd: new Date('2025-09-27T21:30:00'),
            pickingOpen: true,
            matchResults: {},
            chatMessages: []
        };

        // Chat state
        let lastReadMessageId = null;
        let unreadCount = 0;

        // Deadline management
        function calculatePickingStatus() {
            const now = new Date();
            const roundData = roundFixtures[gameData.currentRound];
            
            if (!roundData || !roundData.matches || roundData.matches.length === 0) {
                return { isOpen: false, message: 'No fixtures available', deadline: null };
            }
            
            // Find the earliest match in the round
            let earliestMatch = null;
            let earliestTime = null;
            
            roundData.matches.forEach(match => {
                let matchDate;
                if (match.day.includes('26th')) {
                    matchDate = new Date('2025-09-26T' + match.time);
                } else if (match.day.includes('27th')) {
                    matchDate = new Date('2025-09-27T' + match.time);
                } else {
                    // Handle other dates - for now use a default
                    matchDate = new Date('2025-09-26T' + match.time);
                }
                
                if (!earliestTime || matchDate < earliestTime) {
                    earliestTime = matchDate;
                    earliestMatch = match;
                }
            });
            
            if (!earliestTime) {
                return { isOpen: false, message: 'No valid match times', deadline: null };
            }
            
            // Deadline is 30 minutes before the earliest match
            const deadline = new Date(earliestTime.getTime() - (30 * 60 * 1000));
            
            // Round opens on Monday at midnight (start of the week)
            const roundStartDate = new Date(deadline);
            roundStartDate.setDate(roundStartDate.getDate() - 4); // Go back to Monday
            roundStartDate.setHours(0, 0, 0, 0);
            
            const isOpen = now >= roundStartDate && now < deadline;
            
            let message = '';
            let timeUntil = '';
            
            if (now < roundStartDate) {
                const timeToOpen = roundStartDate.getTime() - now.getTime();
                const days = Math.floor(timeToOpen / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeToOpen % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                message = `üîí Picking opens in ${days}d ${hours}h`;
            } else if (isOpen) {
                const timeToClose = deadline.getTime() - now.getTime();
                const hours = Math.floor(timeToClose / (1000 * 60 * 60));
                const minutes = Math.floor((timeToClose % (1000 * 60 * 60)) / (1000 * 60));
                message = `üü¢ Picking is OPEN`;
                timeUntil = `Closes in ${hours}h ${minutes}m`;
            } else {
                message = `üîí Picking is CLOSED`;
                timeUntil = 'Round in progress';
            }
            
            return {
                isOpen: isOpen,
                message: message,
                timeUntil: timeUntil,
                deadline: deadline,
                roundStart: roundStartDate
            };
        }

        // Email verification state
        let verificationState = {
            email: null,
            code: null,
            expiresAt: null,
            attempts: 0,
            maxAttempts: 3,
            timer: null
        };

        // Registration state
        let registrationData = {
            email: '',
            displayName: '',
            profilePic: null,
            isCustomPic: false,
            favoriteTeam: ''
        };

        // Helper function to check if match is live
        function isMatchLive(match) {
            const now = new Date();
            const kickoffTime = new Date(`2025-09-${match.day.includes('26th') ? '26' : '27'} ${match.time}`);
            const endTime = new Date(kickoffTime.getTime() + (120 * 60 * 1000)); // 120 minutes after kickoff
            return now >= kickoffTime && now <= endTime;
        }

        // Round fixtures
        const roundFixtures = {
            1: {
                teams: ['Stormers', 'Leinster', 'Glasgow Warriors', 'Sharks', 'Ulster', 'Dragons', 'Bulls', 'Ospreys', 'Zebre', 'Edinburgh', 'Scarlets', 'Munster', 'Cardiff Rugby', 'Lions', 'Connacht', 'Benetton Rugby'],
                matches: [
                    { id: 'r1g1', home: 'Stormers', away: 'Leinster', time: '18:00', day: 'Friday 26th September' },
                    { id: 'r1g2', home: 'Glasgow Warriors', away: 'Sharks', time: '20:05', day: 'Friday 26th September' },
                    { id: 'r1g3', home: 'Ulster', away: 'Dragons', time: '20:05', day: 'Friday 26th September' },
                    { id: 'r1g4', home: 'Bulls', away: 'Ospreys', time: '13:00', day: 'Saturday 27th September' },
                    { id: 'r1g5', home: 'Zebre', away: 'Edinburgh', time: '15:05', day: 'Saturday 27th September' },
                    { id: 'r1g6', home: 'Scarlets', away: 'Munster', time: '17:30', day: 'Saturday 27th September' },
                    { id: 'r1g7', home: 'Cardiff Rugby', away: 'Lions', time: '19:45', day: 'Saturday 27th September' },
                    { id: 'r1g8', home: 'Connacht', away: 'Benetton Rugby', time: '19:45', day: 'Saturday 27th September' }
                ]
            },
            2: {
                teams: ['Stormers', 'Ospreys', 'Dragons', 'Sharks', 'Edinburgh', 'Ulster', 'Connacht', 'Scarlets', 'Benetton Rugby', 'Glasgow Warriors', 'Bulls', 'Leinster', 'Munster', 'Cardiff Rugby', 'Zebre', 'Lions'],
                matches: [
                    { id: 'r2g1', home: 'Stormers', away: 'Ospreys', time: '18:00', day: 'Friday 3rd October' },
                    { id: 'r2g2', home: 'Dragons', away: 'Sharks', time: '20:05', day: 'Friday 3rd October' },
                    { id: 'r2g3', home: 'Edinburgh', away: 'Ulster', time: '20:05', day: 'Friday 3rd October' },
                    { id: 'r2g4', home: 'Connacht', away: 'Scarlets', time: '13:45', day: 'Saturday 4th October' },
                    { id: 'r2g5', home: 'Benetton Rugby', away: 'Glasgow Warriors', time: '17:30', day: 'Saturday 4th October' },
                    { id: 'r2g6', home: 'Bulls', away: 'Leinster', time: '17:30', day: 'Saturday 4th October' },
                    { id: 'r2g7', home: 'Munster', away: 'Cardiff Rugby', time: '19:45', day: 'Saturday 4th October' },
                    { id: 'r2g8', home: 'Zebre', away: 'Lions', time: '15:00', day: 'Sunday 5th October' }
                ]
            },
            3: {
                teams: ['Munster', 'Edinburgh', 'Scarlets', 'Stormers', 'Benetton Rugby', 'Lions', 'Ospreys', 'Zebre', 'Glasgow Warriors', 'Dragons', 'Leinster', 'Sharks', 'Cardiff Rugby', 'Connacht', 'Ulster', 'Bulls'],
                matches: [
                    { id: 'r3g1', home: 'Munster', away: 'Edinburgh', time: '19:45', day: 'Friday 10th October' },
                    { id: 'r3g2', home: 'Scarlets', away: 'Stormers', time: '19:45', day: 'Friday 10th October' },
                    { id: 'r3g3', home: 'Benetton Rugby', away: 'Lions', time: '15:00', day: 'Saturday 11th October' },
                    { id: 'r3g4', home: 'Ospreys', away: 'Zebre', time: '15:00', day: 'Saturday 11th October' },
                    { id: 'r3g5', home: 'Glasgow Warriors', away: 'Dragons', time: '17:30', day: 'Saturday 11th October' },
                    { id: 'r3g6', home: 'Leinster', away: 'Sharks', time: '17:30', day: 'Saturday 11th October' },
                    { id: 'r3g7', home: 'Cardiff Rugby', away: 'Connacht', time: '19:45', day: 'Saturday 11th October' },
                    { id: 'r3g8', home: 'Ulster', away: 'Bulls', time: '19:45', day: 'Saturday 11th October' }
                ]
            },
            4: {
                teams: ['Connacht', 'Bulls', 'Dragons', 'Cardiff Rugby', 'Edinburgh', 'Benetton Rugby', 'Lions', 'Scarlets', 'Sharks', 'Ulster', 'Leinster', 'Munster', 'Ospreys', 'Glasgow Warriors', 'Zebre', 'Stormers'],
                matches: [
                    { id: 'r4g1', home: 'Connacht', away: 'Bulls', time: '19:45', day: 'Friday 17th October' },
                    { id: 'r4g2', home: 'Dragons', away: 'Cardiff Rugby', time: '19:45', day: 'Friday 17th October' },
                    { id: 'r4g3', home: 'Edinburgh', away: 'Benetton Rugby', time: '19:45', day: 'Friday 17th October' },
                    { id: 'r4g4', home: 'Lions', away: 'Scarlets', time: '12:45', day: 'Saturday 18th October' },
                    { id: 'r4g5', home: 'Sharks', away: 'Ulster', time: '15:00', day: 'Saturday 18th October' },
                    { id: 'r4g6', home: 'Leinster', away: 'Munster', time: '17:15', day: 'Saturday 18th October' },
                    { id: 'r4g7', home: 'Ospreys', away: 'Glasgow Warriors', time: '19:45', day: 'Saturday 18th October' },
                    { id: 'r4g8', home: 'Zebre', away: 'Stormers', time: '19:45', day: 'Saturday 18th October' }
                ]
            },
            5: {
                teams: ['Glasgow Warriors', 'Bulls', 'Lions', 'Ulster', 'Sharks', 'Scarlets', 'Benetton Rugby', 'Stormers', 'Dragons', 'Ospreys', 'Leinster', 'Zebre', 'Cardiff Rugby', 'Edinburgh', 'Munster', 'Connacht'],
                matches: [
                    { id: 'r5g1', home: 'Glasgow Warriors', away: 'Bulls', time: '19:45', day: 'Friday 24th October' },
                    { id: 'r5g2', home: 'Lions', away: 'Ulster', time: '12:45', day: 'Saturday 25th October' },
                    { id: 'r5g3', home: 'Sharks', away: 'Scarlets', time: '15:00', day: 'Saturday 25th October' },
                    { id: 'r5g4', home: 'Benetton Rugby', away: 'Stormers', time: '17:30', day: 'Saturday 25th October' },
                    { id: 'r5g5', home: 'Dragons', away: 'Ospreys', time: '17:30', day: 'Saturday 25th October' },
                    { id: 'r5g6', home: 'Leinster', away: 'Zebre', time: '17:30', day: 'Saturday 25th October' },
                    { id: 'r5g7', home: 'Cardiff Rugby', away: 'Edinburgh', time: '19:45', day: 'Saturday 25th October' },
                    { id: 'r5g8', home: 'Munster', away: 'Connacht', time: '19:45', day: 'Saturday 25th October' }
                ]
            },
            6: {
                teams: ['Dragons', 'Leinster', 'Ulster', 'Benetton Rugby', 'Bulls', 'Lions', 'Zebre', 'Cardiff Rugby', 'Edinburgh', 'Ospreys', 'Munster', 'Stormers', 'Connacht', 'Sharks', 'Scarlets', 'Glasgow Warriors'],
                matches: [
                    { id: 'r6g1', home: 'Dragons', away: 'Leinster', time: '19:45', day: 'Friday 28th November' },
                    { id: 'r6g2', home: 'Ulster', away: 'Benetton Rugby', time: '19:45', day: 'Friday 28th November' },
                    { id: 'r6g3', home: 'Bulls', away: 'Lions', time: '12:00', day: 'Saturday 29th November' },
                    { id: 'r6g4', home: 'Zebre', away: 'Cardiff Rugby', time: '13:00', day: 'Saturday 29th November' },
                    { id: 'r6g5', home: 'Edinburgh', away: 'Ospreys', time: '17:30', day: 'Saturday 29th November' },
                    { id: 'r6g6', home: 'Munster', away: 'Stormers', time: '17:30', day: 'Saturday 29th November' },
                    { id: 'r6g7', home: 'Connacht', away: 'Sharks', time: '19:45', day: 'Saturday 29th November' },
                    { id: 'r6g8', home: 'Scarlets', away: 'Glasgow Warriors', time: '19:45', day: 'Saturday 29th November' }
                ]
            },
            7: {
                teams: ['Cardiff Rugby', 'Scarlets', 'Leinster', 'Ulster', 'Stormers', 'Lions', 'Benetton Rugby', 'Zebre', 'Glasgow Warriors', 'Edinburgh', 'Sharks', 'Bulls', 'Ospreys', 'Munster', 'Dragons', 'Connacht'],
                matches: [
                    { id: 'r7g1', home: 'Cardiff Rugby', away: 'Scarlets', time: '19:45', day: 'Friday 19th December' },
                    { id: 'r7g2', home: 'Leinster', away: 'Ulster', time: '19:45', day: 'Friday 19th December' },
                    { id: 'r7g3', home: 'Stormers', away: 'Lions', time: '13:30', day: 'Saturday 20th December' },
                    { id: 'r7g4', home: 'Benetton Rugby', away: 'Zebre', time: '14:00', day: 'Saturday 20th December' },
                    { id: 'r7g5', home: 'Glasgow Warriors', away: 'Edinburgh', time: '15:00', day: 'Saturday 20th December' },
                    { id: 'r7g6', home: 'Sharks', away: 'Bulls', time: '16:00', day: 'Saturday 20th December' },
                    { id: 'r7g7', home: 'Ospreys', away: 'Munster', time: '17:30', day: 'Saturday 20th December' },
                    { id: 'r7g8', home: 'Dragons', away: 'Connacht', time: '19:45', day: 'Saturday 20th December' }
                ]
            },
            8: {
                teams: ['Bulls', 'Stormers', 'Lions', 'Sharks', 'Cardiff Rugby', 'Dragons', 'Scarlets', 'Ospreys', 'Zebre', 'Benetton Rugby', 'Edinburgh', 'Glasgow Warriors', 'Connacht', 'Ulster', 'Munster', 'Leinster'],
                matches: [
                    { id: 'r8g1', home: 'Bulls', away: 'Stormers', time: '00:00', day: 'Friday 26th December' },
                    { id: 'r8g2', home: 'Lions', away: 'Sharks', time: '00:00', day: 'Friday 26th December' },
                    { id: 'r8g3', home: 'Cardiff Rugby', away: 'Dragons', time: '15:00', day: 'Friday 26th December' },
                    { id: 'r8g4', home: 'Scarlets', away: 'Ospreys', time: '17:30', day: 'Friday 26th December' },
                    { id: 'r8g5', home: 'Zebre', away: 'Benetton Rugby', time: '14:30', day: 'Saturday 27th December' },
                    { id: 'r8g6', home: 'Edinburgh', away: 'Glasgow Warriors', time: '15:00', day: 'Saturday 27th December' },
                    { id: 'r8g7', home: 'Connacht', away: 'Ulster', time: '17:30', day: 'Saturday 27th December' },
                    { id: 'r8g8', home: 'Munster', away: 'Leinster', time: '19:45', day: 'Saturday 27th December' }
                ]
            },
            9: {
                teams: ['Dragons', 'Scarlets', 'Ospreys', 'Cardiff Rugby', 'Ulster', 'Munster', 'Sharks', 'Lions', 'Stormers', 'Bulls', 'Benetton Rugby', 'Edinburgh', 'Leinster', 'Connacht', 'Glasgow Warriors', 'Zebre'],
                matches: [
                    { id: 'r9g1', home: 'Dragons', away: 'Scarlets', time: '15:00', day: 'Thursday 1st January' },
                    { id: 'r9g2', home: 'Ospreys', away: 'Cardiff Rugby', time: '17:30', day: 'Thursday 1st January' },
                    { id: 'r9g3', home: 'Ulster', away: 'Munster', time: '19:45', day: 'Friday 2nd January' },
                    { id: 'r9g4', home: 'Sharks', away: 'Lions', time: '13:30', day: 'Saturday 3rd January' },
                    { id: 'r9g5', home: 'Stormers', away: 'Bulls', time: '16:00', day: 'Saturday 3rd January' },
                    { id: 'r9g6', home: 'Benetton Rugby', away: 'Edinburgh', time: '17:30', day: 'Saturday 3rd January' },
                    { id: 'r9g7', home: 'Leinster', away: 'Connacht', time: '17:30', day: 'Saturday 3rd January' },
                    { id: 'r9g8', home: 'Glasgow Warriors', away: 'Zebre', time: '19:45', day: 'Saturday 3rd January' }
                ]
            },
            10: {
                teams: ['Edinburgh', 'Bulls', 'Munster', 'Dragons', 'Ospreys', 'Lions', 'Scarlets', 'Ulster', 'Connacht', 'Leinster', 'Stormers', 'Sharks', 'Cardiff Rugby', 'Benetton Rugby', 'Zebre', 'Glasgow Warriors'],
                matches: [
                    { id: 'r10g1', home: 'Edinburgh', away: 'Bulls', time: '19:45', day: 'Friday 23rd January' },
                    { id: 'r10g2', home: 'Munster', away: 'Dragons', time: '19:45', day: 'Friday 23rd January' },
                    { id: 'r10g3', home: 'Ospreys', away: 'Lions', time: '19:45', day: 'Friday 23rd January' },
                    { id: 'r10g4', home: 'Scarlets', away: 'Ulster', time: '15:00', day: 'Saturday 24th January' },
                    { id: 'r10g5', home: 'Connacht', away: 'Leinster', time: '17:30', day: 'Saturday 24th January' },
                    { id: 'r10g6', home: 'Stormers', away: 'Sharks', time: '17:30', day: 'Saturday 24th January' },
                    { id: 'r10g7', home: 'Cardiff Rugby', away: 'Benetton Rugby', time: '19:45', day: 'Saturday 24th January' },
                    { id: 'r10g8', home: 'Zebre', away: 'Glasgow Warriors', time: '19:45', day: 'Saturday 24th January' }
                ]
            },
            11: {
                teams: ['Benetton Rugby', 'Scarlets', 'Glasgow Warriors', 'Munster', 'Lions', 'Bulls', 'Sharks', 'Stormers', 'Zebre', 'Connacht', 'Leinster', 'Edinburgh', 'Ospreys', 'Dragons', 'Ulster', 'Cardiff Rugby'],
                matches: [
                    { id: 'r11g1', home: 'Benetton Rugby', away: 'Scarlets', time: '19:45', day: 'Friday 30th January' },
                    { id: 'r11g2', home: 'Glasgow Warriors', away: 'Munster', time: '19:45', day: 'Friday 30th January' },
                    { id: 'r11g3', home: 'Lions', away: 'Bulls', time: '12:30', day: 'Saturday 31st January' },
                    { id: 'r11g4', home: 'Sharks', away: 'Stormers', time: '15:00', day: 'Saturday 31st January' },
                    { id: 'r11g5', home: 'Zebre', away: 'Connacht', time: '15:00', day: 'Saturday 31st January' },
                    { id: 'r11g6', home: 'Leinster', away: 'Edinburgh', time: '17:30', day: 'Saturday 31st January' },
                    { id: 'r11g7', home: 'Ospreys', away: 'Dragons', time: '19:45', day: 'Saturday 31st January' },
                    { id: 'r11g8', home: 'Ulster', away: 'Cardiff Rugby', time: '19:45', day: 'Saturday 31st January' }
                ]
            },
            12: {
                teams: ['Cardiff Rugby', 'Leinster', 'Edinburgh', 'Scarlets', 'Lions', 'Stormers', 'Bulls', 'Sharks', 'Connacht', 'Glasgow Warriors', 'Dragons', 'Benetton Rugby', 'Munster', 'Zebre', 'Ospreys', 'Ulster'],
                matches: [
                    { id: 'r12g1', home: 'Cardiff Rugby', away: 'Leinster', time: '19:45', day: 'Friday 27th February' },
                    { id: 'r12g2', home: 'Edinburgh', away: 'Scarlets', time: '19:45', day: 'Friday 27th February' },
                    { id: 'r12g3', home: 'Lions', away: 'Stormers', time: '12:30', day: 'Saturday 28th February' },
                    { id: 'r12g4', home: 'Bulls', away: 'Sharks', time: '15:00', day: 'Saturday 28th February' },
                    { id: 'r12g5', home: 'Connacht', away: 'Glasgow Warriors', time: '15:00', day: 'Saturday 28th February' },
                    { id: 'r12g6', home: 'Dragons', away: 'Benetton Rugby', time: '17:30', day: 'Saturday 28th February' },
                    { id: 'r12g7', home: 'Munster', away: 'Zebre', time: '17:30', day: 'Saturday 28th February' },
                    { id: 'r12g8', home: 'Ospreys', away: 'Ulster', time: '19:45', day: 'Saturday 28th February' }
                ]
            },
            13: {
                teams: ['Bulls', 'Cardiff Rugby', 'Scarlets', 'Zebre', 'Ulster', 'Connacht', 'Lions', 'Edinburgh', 'Benetton Rugby', 'Ospreys', 'Sharks', 'Munster', 'Glasgow Warriors', 'Leinster', 'Stormers', 'Dragons'],
                matches: [
                    { id: 'r13g1', home: 'Bulls', away: 'Cardiff Rugby', time: '17:00', day: 'Friday 20th March' },
                    { id: 'r13g2', home: 'Scarlets', away: 'Zebre', time: '19:45', day: 'Friday 20th March' },
                    { id: 'r13g3', home: 'Ulster', away: 'Connacht', time: '19:45', day: 'Friday 20th March' },
                    { id: 'r13g4', home: 'Lions', away: 'Edinburgh', time: '12:45', day: 'Saturday 21st March' },
                    { id: 'r13g5', home: 'Benetton Rugby', away: 'Ospreys', time: '15:00', day: 'Saturday 21st March' },
                    { id: 'r13g6', home: 'Sharks', away: 'Munster', time: '15:00', day: 'Saturday 21st March' },
                    { id: 'r13g7', home: 'Glasgow Warriors', away: 'Leinster', time: '17:30', day: 'Saturday 21st March' },
                    { id: 'r13g8', home: 'Stormers', away: 'Dragons', time: '17:30', day: 'Saturday 21st March' }
                ]
            },
            14: {
                teams: ['Sharks', 'Cardiff Rugby', 'Glasgow Warriors', 'Benetton Rugby', 'Bulls', 'Munster', 'Connacht', 'Ospreys', 'Lions', 'Dragons', 'Stormers', 'Edinburgh', 'Leinster', 'Scarlets', 'Zebre', 'Ulster'],
                matches: [
                    { id: 'r14g1', home: 'Sharks', away: 'Cardiff Rugby', time: '17:00', day: 'Friday 27th March' },
                    { id: 'r14g2', home: 'Glasgow Warriors', away: 'Benetton Rugby', time: '19:45', day: 'Friday 27th March' },
                    { id: 'r14g3', home: 'Bulls', away: 'Munster', time: '12:00', day: 'Saturday 28th March' },
                    { id: 'r14g4', home: 'Connacht', away: 'Ospreys', time: '14:15', day: 'Saturday 28th March' },
                    { id: 'r14g5', home: 'Lions', away: 'Dragons', time: '14:30', day: 'Saturday 28th March' },
                    { id: 'r14g6', home: 'Stormers', away: 'Edinburgh', time: '17:00', day: 'Saturday 28th March' },
                    { id: 'r14g7', home: 'Leinster', away: 'Scarlets', time: '17:30', day: 'Saturday 28th March' },
                    { id: 'r14g8', home: 'Zebre', away: 'Ulster', time: '19:45', day: 'Saturday 28th March' }
                ]
            },
            15: {
                teams: ['Dragons', 'Bulls', 'Edinburgh', 'Zebre', 'Ulster', 'Leinster', 'Lions', 'Glasgow Warriors', 'Stormers', 'Connacht', 'Scarlets', 'Cardiff Rugby', 'Benetton Rugby', 'Munster', 'Ospreys', 'Sharks'],
                matches: [
                    { id: 'r15g1', home: 'Dragons', away: 'Bulls', time: '19:45', day: 'Friday 17th April' },
                    { id: 'r15g2', home: 'Edinburgh', away: 'Zebre', time: '19:45', day: 'Friday 17th April' },
                    { id: 'r15g3', home: 'Ulster', away: 'Leinster', time: '19:45', day: 'Friday 17th April' },
                    { id: 'r15g4', home: 'Lions', away: 'Glasgow Warriors', time: '14:45', day: 'Saturday 18th April' },
                    { id: 'r15g5', home: 'Stormers', away: 'Connacht', time: '17:15', day: 'Saturday 18th April' },
                    { id: 'r15g6', home: 'Scarlets', away: 'Cardiff Rugby', time: '17:30', day: 'Saturday 18th April' },
                    { id: 'r15g7', home: 'Benetton Rugby', away: 'Munster', time: '19:45', day: 'Saturday 18th April' },
                    { id: 'r15g8', home: 'Ospreys', away: 'Sharks', time: '19:45', day: 'Saturday 18th April' }
                ]
            },
            16: {
                teams: ['Cardiff Rugby', 'Ospreys', 'Edinburgh', 'Sharks', 'Zebre', 'Dragons', 'Lions', 'Connacht', 'Munster', 'Ulster', 'Stormers', 'Glasgow Warriors', 'Benetton Rugby', 'Leinster', 'Scarlets', 'Bulls'],
                matches: [
                    { id: 'r16g1', home: 'Cardiff Rugby', away: 'Ospreys', time: '19:45', day: 'Friday 24th April' },
                    { id: 'r16g2', home: 'Edinburgh', away: 'Sharks', time: '19:45', day: 'Friday 24th April' },
                    { id: 'r16g3', home: 'Zebre', away: 'Dragons', time: '19:45', day: 'Friday 24th April' },
                    { id: 'r16g4', home: 'Lions', away: 'Connacht', time: '15:00', day: 'Saturday 25th April' },
                    { id: 'r16g5', home: 'Munster', away: 'Ulster', time: '17:30', day: 'Saturday 25th April' },
                    { id: 'r16g6', home: 'Stormers', away: 'Glasgow Warriors', time: '17:30', day: 'Saturday 25th April' },
                    { id: 'r16g7', home: 'Benetton Rugby', away: 'Leinster', time: '19:45', day: 'Saturday 25th April' },
                    { id: 'r16g8', home: 'Scarlets', away: 'Bulls', time: '19:45', day: 'Saturday 25th April' }
                ]
            },
            17: {
                teams: ['TBD', 'TBD', 'TBD', 'TBD'],
                matches: [
                    { id: 'sf1', home: 'TBD', away: 'TBD', time: 'TBD', day: 'Friday 6th June' },
                    { id: 'sf2', home: 'TBD', away: 'TBD', time: 'TBD', day: 'Friday 6th June' }
                ]
            },
            18: {
                teams: ['TBD', 'TBD'],
                matches: [
                    { id: 'final', home: 'TBD', away: 'TBD', time: 'TBD', day: 'Friday 20th June' }
                ]
            }
        };

        let showEliminated = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
            setupEventListeners();
            updateGameStatus();
            updateUI();
            setInterval(() => {
                updateGameStatus();
            }, 30000);
        });

        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchTab('register'));
            
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // Game mode toggles
            document.getElementById('lmsToggle').addEventListener('click', () => switchGameMode('lms'));
            document.getElementById('pickItToggle').addEventListener('click', () => switchGameMode('pickit'));
            
            // LMS Navigation tabs
            document.getElementById('currentRoundTab').addEventListener('click', () => switchFixtureTab('current'));
            document.getElementById('fixturesTab').addEventListener('click', () => switchFixtureTab('all'));
            
            // Pick it! Navigation tabs
            document.getElementById('pickItCurrentTab').addEventListener('click', () => switchPickItTab('current'));
            document.getElementById('pickItLeaderboardTab').addEventListener('click', () => switchPickItTab('leaderboard'));
            document.getElementById('pickItFixturesTab').addEventListener('click', () => switchPickItTab('fixtures'));
            
            // Round selectors
            document.getElementById('roundSelector').addEventListener('change', updateAllFixtures);
            document.getElementById('pickItRoundSelector').addEventListener('change', updatePickItAllFixtures);
            
            // Confirm pick
            document.getElementById('confirmPick').addEventListener('click', confirmPick);
            document.getElementById('savePickItPicks').addEventListener('click', savePickItPicks);
            
            // Toggle eliminated
            document.getElementById('toggleEliminated').addEventListener('click', toggleEliminatedPlayers);
            
            // View picks modal
            document.getElementById('viewPicksCard').addEventListener('click', openPicksModal);
            document.getElementById('closePicksModal').addEventListener('click', closePicksModal);
            
            // Player list modals
            document.getElementById('standingPlayersCard').addEventListener('click', () => openPlayerListModal('standing'));
            document.getElementById('eliminatedPlayersCard').addEventListener('click', () => openPlayerListModal('eliminated'));
            document.getElementById('leaderboardCard').addEventListener('click', openLeaderboardModal);
            document.getElementById('closePlayerListModal').addEventListener('click', closePlayerListModal);
            
            // Admin modal
            document.getElementById('adminScores').addEventListener('click', openAdminModal);
            document.getElementById('closeAdminModal').addEventListener('click', closeAdminModal);
            
            // Admin tabs
            document.getElementById('adminScoresTab').addEventListener('click', () => switchAdminTab('scores'));
            document.getElementById('adminPlayersTab').addEventListener('click', () => switchAdminTab('players'));
            
            // Admin round selector
            document.getElementById('adminRoundSelector').addEventListener('change', populateAdminScores);
            
            // Admin tabs
            document.getElementById('adminPlayoffsTab').addEventListener('click', () => switchAdminTab('playoffs'));
            
            // Chat functionality
            document.getElementById('chatToggleBtn').addEventListener('click', toggleChat);
            document.getElementById('closeChatBtn').addEventListener('click', closeChat);
            document.getElementById('chatForm').addEventListener('submit', sendMessage);
            document.getElementById('chatInput').addEventListener('input', updateCharCount);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Settings
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            document.getElementById('cancelSettings').addEventListener('click', closeSettingsModal);
            
            // Profile modal
            document.getElementById('closeProfileModal').addEventListener('click', closeProfileModal);
            
            // Password reset
            document.getElementById('forgotPasswordBtn').addEventListener('click', showPasswordReset);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            document.getElementById('cancelResetBtn').addEventListener('click', hidePasswordReset);
            
            // Email verification
            document.getElementById('resendCode').addEventListener('click', resendVerificationCode);
            
            // Custom profile picture uploads
            document.getElementById('customProfilePic').addEventListener('change', handleCustomProfilePic);
            document.getElementById('removeCustomPic').addEventListener('click', removeCustomProfilePic);
            document.getElementById('settingsCustomProfilePic').addEventListener('change', handleSettingsCustomProfilePic);
            document.getElementById('settingsRemoveCustomPic').addEventListener('click', removeSettingsCustomProfilePic);
        }

        function loadGameData() {
            const saved = localStorage.getItem('urcGameData');
            if (saved) {
                gameData = { ...gameData, ...JSON.parse(saved) };
            }
        }

        function saveGameData() {
            localStorage.setItem('urcGameData', JSON.stringify(gameData));
        }

        function resetVerificationState() {
            // Reset verification state when switching tabs
            verificationState = {
                email: null,
                code: null,
                expiresAt: null,
                attempts: 0,
                maxAttempts: 3,
                timer: null
            };
        }

        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const nameField = document.getElementById('nameField');
            const profilePicField = document.getElementById('profilePicField');
            const favoriteTeamField = document.getElementById('favoriteTeamField');
            const passwordHelp = document.getElementById('passwordHelp');
            const authButton = document.getElementById('authButton');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const passwordResetForm = document.getElementById('passwordResetForm');
            
            resetVerificationState();
            
            // Hide password reset form when switching tabs
            passwordResetForm.classList.add('hidden');
            
            if (tab === 'login') {
                loginTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-l-lg font-medium';
                registerTab.className = 'flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-r-lg font-medium';
                nameField.classList.add('hidden');
                profilePicField.classList.add('hidden');
                favoriteTeamField.classList.add('hidden');
                passwordHelp.classList.add('hidden');
                forgotPasswordLink.classList.remove('hidden');
                authButton.textContent = 'Login';
            } else {
                loginTab.className = 'flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-l-lg font-medium';
                registerTab.className = 'flex-1 py-2 px-4 bg-blue-600 text-white rounded-r-lg font-medium';
                nameField.classList.remove('hidden');
                profilePicField.classList.remove('hidden');
                favoriteTeamField.classList.remove('hidden');
                passwordHelp.classList.remove('hidden');
                forgotPasswordLink.classList.add('hidden');
                authButton.textContent = 'Register';
            }
        }

        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('displayName').value;
            const authButtonText = document.getElementById('authButton').textContent;
            
            if (authButtonText === 'Login') {
                loginUser(email, password);
            } else if (authButtonText === 'Register') {
                registerUser(email, password, displayName);
            }
        }

        // Enhanced profanity filter function
        function containsProfanity(text) {
            if (!text) return false;
            const profanityList = [
                'fuck', 'shit', 'damn', 'bitch', 'asshole', 'bastard', 'cunt', 'dick', 'piss', 'cock', 'pussy', 'whore', 'slut', 'fag', 'nigger', 'retard',
                'f*ck', 'sh*t', 'b*tch', 'a**hole', 'c*nt', 'd*ck', 'p*ss', 'wh*re', 'sl*t',
                'fck', 'sht', 'btch', 'cnt', 'dck', 'pss', 'whr', 'slt',
                'fucker', 'fucking', 'fucked', 'shitty', 'shitting', 'bitchy', 'dickhead', 'pissed',
                'sex', 'porn', 'xxx', 'anal', 'oral', 'nude', 'naked', 'boobs', 'tits', 'ass',
                'hate', 'kill', 'die', 'death', 'murder', 'suicide', 'nazi', 'hitler',
                'stupid', 'idiot', 'moron', 'dumb', 'loser', 'gay', 'homo', 'lesbian'
            ];
            const lowerText = text.toLowerCase().replace(/[^a-z0-9]/g, '');
            return profanityList.some(word => {
                const cleanWord = word.replace(/[^a-z0-9]/g, '');
                return lowerText.includes(cleanWord);
            });
        }

        function registerUser(email, password, displayName) {
            const existingPlayer = gameData.players.find(p => p.email === email);
            if (existingPlayer) {
                showNotification('Email already registered! Please login instead.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }
            
            if (containsProfanity(displayName)) {
                showNotification('Display name contains inappropriate language. Please choose a different name.', 'error');
                return;
            }
            
            const newPlayer = {
                id: Date.now(),
                email: email,
                password: password,
                displayName: displayName || email.split('@')[0],
                profilePic: registrationData.profilePic,
                isCustomPic: registrationData.isCustomPic || false,
                favoriteTeam: document.getElementById('favoriteTeam').value,
                isEliminated: false,
                usedTeams: [],
                currentPick: null,
                roundJoined: gameData.currentRound,
                joinDate: new Date().toISOString(),
                // Pick it! game data
                pickItPicks: {}, // roundNum: {matchId: teamPicked}
                pickItStats: {
                    totalPicks: 0,
                    correctPicks: 0,
                    percentage: 0,
                    weeklyMovement: 0,
                    previousRank: null
                }
            };
            
            gameData.players.push(newPlayer);
            saveGameData();
            
            showNotification('Registration successful! You can now login and start playing.', 'success');
            
            switchTab('login');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('displayName').value = '';
        }



        function handleCustomProfilePic(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Image must be smaller than 2MB', 'error');
                e.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                
                document.getElementById('customPicImage').src = imageData;
                document.getElementById('customPicPreview').classList.remove('hidden');
                
                registrationData.profilePic = imageData;
                registrationData.isCustomPic = true;
            };
            reader.readAsDataURL(file);
        }
        
        function removeCustomProfilePic() {
            document.getElementById('customPicPreview').classList.add('hidden');
            document.getElementById('customProfilePic').value = '';
            registrationData.profilePic = null;
            registrationData.isCustomPic = false;
        }
        
        function handleSettingsCustomProfilePic(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Image must be smaller than 2MB', 'error');
                e.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                
                document.getElementById('settingsCustomPicImage').src = imageData;
                document.getElementById('settingsCustomPicPreview').classList.remove('hidden');
                
                window.tempCustomPic = imageData;
            };
            reader.readAsDataURL(file);
        }
        
        function removeSettingsCustomProfilePic() {
            document.getElementById('settingsCustomPicPreview').classList.add('hidden');
            document.getElementById('settingsCustomProfilePic').value = '';
            window.tempCustomPic = null;
        }

        function loginUser(email, password) {
            const player = gameData.players.find(p => p.email === email);
            if (!player) {
                showNotification('Email not found. Please register first.', 'error');
                return;
            }
            
            if (player.password !== password) {
                showNotification('Incorrect password. Please try again.', 'error');
                return;
            }
            
            currentUser = player;
            localStorage.setItem('currentUserEmail', email);
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = player.displayName;
            
            const userProfilePicElement = document.getElementById('userProfilePic');
            if (player.isCustomPic && player.profilePic && player.profilePic.startsWith('data:')) {
                userProfilePicElement.innerHTML = `<img src="${player.profilePic}" class="w-8 h-8 rounded-full object-cover border border-gray-300" alt="Profile">`;
            } else {
                userProfilePicElement.innerHTML = `<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgMFCSXJWsbmkra95ltt9Z9LJiRuMOsIBluqwF-g4&usqp=CAE&s" class="w-8 h-8 rounded-full object-cover border border-gray-300" alt="Profile" onerror="this.src=''; this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="w-8 h-8 rounded-full bg-gray-300 border border-gray-400" style="display: none;"></div>`;
            }
            
            if (email === 'sacksjordan@gmail.com') {
                document.getElementById('adminScores').classList.remove('hidden');
            } else {
                document.getElementById('adminScores').classList.add('hidden');
            }
            
            showNotification(`Welcome back, ${player.displayName}!`, 'success');
            updateUI();
        }



        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUserEmail');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('displayName').value = '';
        }

        function selectTeam(teamName) {
            const status = calculatePickingStatus();
            if (!status.isOpen || currentUser.isEliminated) return;
            
            const roundData = roundFixtures[gameData.currentRound];
            const availableTeams = roundData ? roundData.teams : [];
            if (!availableTeams.includes(teamName)) {
                alert('This team is not playing in the current round!');
                return;
            }
            
            // Disallow previously used teams from prior rounds, but allow changing within this round
            const startRound = currentUser.roundJoined || 1;
            const roundIndex = Math.max(0, (gameData.currentRound || 1) - startRound);
            const usedPreviously = currentUser.usedTeams
                .slice(0, roundIndex)
                .filter(t => !!t)
                .includes(teamName);
            if (usedPreviously) {
                alert('You have already used this team in a previous round!');
                return;
            }
            
            document.querySelectorAll('.team-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.classList.remove('border-blue-500', 'bg-blue-100');
                    btn.classList.add('border-gray-200');
                }
            });
            
            const selectedBtn = document.querySelector(`[data-team="${teamName}"]`);
            if (selectedBtn && !selectedBtn.disabled) {
                selectedBtn.classList.add('border-blue-500', 'bg-blue-100');
                selectedBtn.classList.remove('border-gray-200');
            }
            
            document.getElementById('selectedTeam').classList.remove('hidden');
            document.getElementById('selectedTeamName').textContent = teamName;
            document.getElementById('confirmPick').disabled = false;
            
            currentUser.tempPick = teamName;
        }

        function confirmPick() {
            if (!currentUser.tempPick) return;
            
            // Set current pick and update usedTeams at the correct round index
            currentUser.currentPick = currentUser.tempPick;
            const startRound = currentUser.roundJoined || 1;
            const roundIndex = Math.max(0, (gameData.currentRound || 1) - startRound);
            if (!Array.isArray(currentUser.usedTeams)) currentUser.usedTeams = [];
            if (roundIndex < currentUser.usedTeams.length) {
                currentUser.usedTeams[roundIndex] = currentUser.tempPick;
            } else if (roundIndex === currentUser.usedTeams.length) {
                currentUser.usedTeams.push(currentUser.tempPick);
            } else {
                while (currentUser.usedTeams.length < roundIndex) currentUser.usedTeams.push(null);
                currentUser.usedTeams.push(currentUser.tempPick);
            }
            currentUser.tempPick = null;
            saveGameData();
            updateUI();
            showNotification('Pick confirmed! Good luck!', 'success');
        }



        function switchFixtureTab(tab) {
            const currentTab = document.getElementById('currentRoundTab');
            const fixturesTab = document.getElementById('fixturesTab');
            const currentSection = document.getElementById('currentRoundSection');
            const allSection = document.getElementById('allFixturesSection');
            
            if (tab === 'current') {
                currentTab.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';
                fixturesTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
                currentSection.classList.remove('hidden');
                allSection.classList.add('hidden');
            } else {
                currentTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
                fixturesTab.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';
                currentSection.classList.add('hidden');
                allSection.classList.remove('hidden');
                updateAllFixtures();
            }
        }

        function updateAllFixtures() {
            const selectedRound = document.getElementById('roundSelector').value;
            const content = document.getElementById('allFixturesContent');
            
            let html = '';
            
            if (selectedRound === 'all') {
                // Show all rounds
                Object.keys(roundFixtures).forEach(roundNum => {
                    const roundData = roundFixtures[roundNum];
                    html += `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Round ${roundNum}</h4>
                            <div class="space-y-2">
                    `;
                    
                    // Group matches by day
                    const matchesByDay = {};
                    roundData.matches.forEach(match => {
                        if (!matchesByDay[match.day]) {
                            matchesByDay[match.day] = [];
                        }
                        matchesByDay[match.day].push(match);
                    });
                    
                    Object.keys(matchesByDay).forEach(day => {
                        html += `
                            <div class="mb-3">
                                <h5 class="font-medium text-gray-700 mb-2">${day}</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        `;
                        
                        matchesByDay[day].forEach(match => {
                            const result = gameData.matchResults[match.id];
                            let statusDisplay = '';
                            
                            if (result && result.finished) {
                                statusDisplay = `<span class="text-xs text-green-600 font-medium">‚úÖ ${result.winner}</span>`;
                            } else if (isMatchLive(match)) {
                                statusDisplay = `<span class="text-xs text-red-600 font-medium animate-pulse">üî¥ LIVE</span>`;
                            } else {
                                statusDisplay = `<span class="text-xs text-gray-500">${match.time}</span>`;
                            }
                            
                            html += `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>${match.home} vs ${match.away}</span>
                                    ${statusDisplay}
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            } else {
                // Show specific round
                const roundData = roundFixtures[selectedRound];
                if (roundData) {
                    html += `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Round ${selectedRound}</h4>
                            <div class="space-y-2">
                    `;
                    
                    // Group matches by day
                    const matchesByDay = {};
                    roundData.matches.forEach(match => {
                        if (!matchesByDay[match.day]) {
                            matchesByDay[match.day] = [];
                        }
                        matchesByDay[match.day].push(match);
                    });
                    
                    Object.keys(matchesByDay).forEach(day => {
                        html += `
                            <div class="mb-3">
                                <h5 class="font-medium text-gray-700 mb-2">${day}</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        `;
                        
                        matchesByDay[day].forEach(match => {
                            const result = gameData.matchResults[match.id];
                            let statusDisplay = '';
                            
                            if (result && result.finished) {
                                statusDisplay = `<span class="text-xs text-green-600 font-medium">‚úÖ ${result.winner}</span>`;
                            } else if (isMatchLive(match)) {
                                statusDisplay = `<span class="text-xs text-red-600 font-medium animate-pulse">üî¥ LIVE</span>`;
                            } else {
                                statusDisplay = `<span class="text-xs text-gray-500">${match.time}</span>`;
                            }
                            
                            html += `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                                    <span>${match.home} vs ${match.away}</span>
                                    ${statusDisplay}
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html || '<div class="text-center text-gray-500 py-8">No fixtures available</div>';
        }

        function updateGameStatus() {
            const status = calculatePickingStatus();
            gameData.pickingOpen = status.isOpen;
            
            document.getElementById('statusMessage').textContent = status.message;
            document.getElementById('countdown').textContent = status.timeUntil || 'Deadline: Friday 26th September at 17:30';
            const lmsInline = document.getElementById('lmsCountdownInline');
            if (lmsInline) {
                if (status.isOpen) {
                    lmsInline.innerHTML = `<span class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium bg-green-100 text-green-800">üü¢ Open ‚Äî ${status.timeUntil}</span>`;
                } else {
                    lmsInline.innerHTML = `<span class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium bg-red-100 text-red-800">üîí Round started ‚Äî Picking locked</span>`;
                }
            }
            
            // Update round status indicator
            const indicator = document.getElementById('roundStatusIndicator');
            if (status.isOpen) {
                indicator.className = 'mt-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                indicator.innerHTML = 'üü¢ Round Open - Picking Available';
            } else {
                indicator.className = 'mt-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                indicator.innerHTML = 'üîí Round Closed - Picking Locked';
            }
        }

        function generateTeamButtons() {
            const teamButtonsContainer = document.getElementById('teamButtons');
            const roundData = roundFixtures[gameData.currentRound];
            const availableTeams = roundData ? roundData.teams : [];
            const status = calculatePickingStatus();
            
            teamButtonsContainer.innerHTML = '';
            
            availableTeams.forEach(team => {
                const isUsed = currentUser && currentUser.usedTeams.includes(team);
                const isDisabled = isUsed || !status.isOpen || currentUser.isEliminated;
                
                const button = document.createElement('button');
                button.className = `team-btn p-3 border-2 rounded-lg transition-colors ${
                    isDisabled 
                        ? 'border-gray-400 bg-gray-200 text-gray-500 cursor-not-allowed opacity-60' 
                        : 'border-gray-200 hover:border-blue-500 hover:bg-blue-50'
                }`;
                button.dataset.team = team;
                button.disabled = isDisabled;
                
                if (isUsed) {
                    button.innerHTML = `${team} <span class="text-xs">‚úó</span>`;
                } else if (!status.isOpen) {
                    button.innerHTML = `${team} <span class="text-xs">üîí</span>`;
                } else {
                    button.innerHTML = team;
                }
                
                if (!isDisabled) {
                    button.addEventListener('click', () => selectTeam(team));
                }
                
                teamButtonsContainer.appendChild(button);
            });
        }

        // Game mode switching
        function switchGameMode(mode) {
            currentGameMode = mode;
            
            const lmsToggle = document.getElementById('lmsToggle');
            const pickItToggle = document.getElementById('pickItToggle');
            const lmsInterface = document.getElementById('lmsInterface');
            const pickItInterface = document.getElementById('pickItInterface');
            const lmsStats = document.getElementById('lmsStats');
            const pickItStats = document.getElementById('pickItStats');
            
            if (mode === 'lms') {
                lmsToggle.className = 'px-6 py-2 bg-blue-600 text-white rounded-lg font-medium transition-colors';
                pickItToggle.className = 'px-6 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-200';
                lmsInterface.classList.remove('hidden');
                pickItInterface.classList.add('hidden');
                lmsStats.classList.remove('hidden');
                pickItStats.classList.add('hidden');
            } else {
                lmsToggle.className = 'px-6 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-200';
                pickItToggle.className = 'px-6 py-2 bg-green-600 text-white rounded-lg font-medium transition-colors';
                lmsInterface.classList.add('hidden');
                pickItInterface.classList.remove('hidden');
                lmsStats.classList.add('hidden');
                pickItStats.classList.remove('hidden');
                
                updatePickItInterface();
            }
            
            updateUI();
        }

        // Pick it! tab switching
        function switchPickItTab(tab) {
            const currentTab = document.getElementById('pickItCurrentTab');
            const leaderboardTab = document.getElementById('pickItLeaderboardTab');
            const fixturesTab = document.getElementById('pickItFixturesTab');
            const currentSection = document.getElementById('pickItCurrentSection');
            const leaderboardSection = document.getElementById('pickItLeaderboardSection');
            const fixturesSection = document.getElementById('pickItAllFixturesSection');
            
            // Reset all tabs
            currentTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            leaderboardTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            fixturesTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            currentSection.classList.add('hidden');
            leaderboardSection.classList.add('hidden');
            fixturesSection.classList.add('hidden');
            
            if (tab === 'current') {
                currentTab.className = 'px-4 py-2 bg-green-600 text-white rounded-lg font-medium';
                currentSection.classList.remove('hidden');
                updatePickItInterface();
            } else if (tab === 'leaderboard') {
                leaderboardTab.className = 'px-4 py-2 bg-green-600 text-white rounded-lg font-medium';
                leaderboardSection.classList.remove('hidden');
                updatePickItLeaderboard();
            } else if (tab === 'fixtures') {
                fixturesTab.className = 'px-4 py-2 bg-green-600 text-white rounded-lg font-medium';
                fixturesSection.classList.remove('hidden');
                updatePickItAllFixtures();
            }
        }

        function updateUI() {
            if (!currentUser) return;
            
            document.getElementById('currentRound').textContent = gameData.currentRound;
            document.getElementById('picksRoundNumber').textContent = gameData.currentRound;
            document.getElementById('pickItRoundNumber').textContent = gameData.currentRound;
            
            if (currentGameMode === 'lms') {
                // Update LMS stats
                const standingPlayers = gameData.players.filter(p => !p.isEliminated);
                const eliminatedPlayers = gameData.players.filter(p => p.isEliminated);
                
                document.getElementById('playersStanding').textContent = standingPlayers.length;
                document.getElementById('playersEliminated').textContent = eliminatedPlayers.length;
                document.getElementById('totalPlayers').textContent = gameData.players.length;
                
                // Show/hide eliminated toggle button
                const toggleBtn = document.getElementById('toggleEliminated');
                if (eliminatedPlayers.length > 0) {
                    toggleBtn.classList.remove('hidden');
                } else {
                    toggleBtn.classList.add('hidden');
                }
                
                generateTeamButtons();
                updatePlayersList();
                updatePicksStatus();
                
                if (currentUser.currentPick) {
                    document.getElementById('selectedTeam').classList.remove('hidden');
                    document.getElementById('selectedTeamName').textContent = currentUser.currentPick;
                    document.getElementById('confirmPick').textContent = 'Pick Confirmed ‚úì';
                    document.getElementById('confirmPick').disabled = true;
                    document.getElementById('confirmPick').classList.add('bg-green-500');
                }
            } else {
                // Update Pick it! stats
                updatePickItStats();
            }
        }

        function updatePickItStats() {
            if (!currentUser || !currentUser.pickItStats) return;
            
            const stats = currentUser.pickItStats;
            const leaderboard = calculatePickItLeaderboard();
            const userRank = leaderboard.findIndex(p => p.id === currentUser.id) + 1;
            
            document.getElementById('currentRank').textContent = userRank > 0 ? `#${userRank}` : '-';
            document.getElementById('pickPercentage').textContent = `${Math.round(stats.percentage || 0)}%`;
            document.getElementById('correctPicks').textContent = `${stats.correctPicks || 0}/${stats.totalPicks || 0}`;
        }

        function updatePickItInterface() {
            if (!currentUser) return;
            
            const roundData = roundFixtures[gameData.currentRound];
            if (!roundData) return;
            
            const container = document.getElementById('pickItMatches');
            const userPicks = currentUser.pickItPicks[gameData.currentRound] || {};
            const status = calculatePickingStatus();
            
            let html = '';
            let picksMade = 0;
            
            // Group matches by day
            const matchesByDay = {};
            roundData.matches.forEach(match => {
                if (!matchesByDay[match.day]) {
                    matchesByDay[match.day] = [];
                }
                matchesByDay[match.day].push(match);
            });
            
            Object.keys(matchesByDay).forEach(day => {
                html += `
                    <div class="mb-4">
                        <h5 class="font-medium text-gray-700 mb-3">${day}</h5>
                        <div class="space-y-3">
                `;
                
                matchesByDay[day].forEach(match => {
                    const userPick = userPicks[match.id];
                    if (userPick) picksMade++;
                    
                    const result = gameData.matchResults[match.id];
                    let statusDisplay = '';
                    
                    if (result && result.finished) {
                        const isCorrect = userPick === result.winner;
                        statusDisplay = `<span class="text-xs ${isCorrect ? 'text-green-600' : 'text-red-600'} font-medium">${isCorrect ? '‚úÖ' : '‚ùå'} ${result.winner}</span>`;
                    } else {
                        statusDisplay = `<span class="text-xs text-gray-500">${match.time}</span>`;
                    }
                    
                    const isDisabled = (result && result.finished) || !status.isOpen;
                    
                    html += `
                        <div class="border rounded-lg p-4 ${userPick ? 'bg-green-50 border-green-200' : 'bg-gray-50'}">
                            <div class="flex justify-between items-center mb-3">
                                <div class="font-medium">${match.home} vs ${match.away}</div>
                                ${statusDisplay}
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="makePickItPick('${match.id}', '${match.home}')" 
                                        class="px-3 py-2 border rounded-lg text-sm transition-colors ${userPick === match.home ? 'bg-green-500 text-white border-green-500' : 'border-gray-300 hover:bg-green-50'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isDisabled ? 'disabled' : ''}>
                                    ${match.home}
                                </button>
                                <button onclick="makePickItPick('${match.id}', '${match.away}')" 
                                        class="px-3 py-2 border rounded-lg text-sm transition-colors ${userPick === match.away ? 'bg-green-500 text-white border-green-500' : 'border-gray-300 hover:bg-green-50'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isDisabled ? 'disabled' : ''}>
                                    ${match.away}
                                </button>
                            </div>
                            ${userPick ? `<div class="mt-2 text-sm text-green-600 font-medium">Your pick: ${userPick}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update progress
            document.getElementById('picksMade').textContent = picksMade;
            document.getElementById('totalMatches').textContent = roundData.matches.length;
            
            // Update deadline display
            document.getElementById('pickItDeadline').textContent = status.isOpen ? 
                `Deadline: ${status.timeUntil}` : 
                'Picking Closed';
            
            // Enable/disable save button
            const saveBtn = document.getElementById('savePickItPicks');
            const allPicksMade = picksMade === roundData.matches.length;
            saveBtn.disabled = !allPicksMade || !status.isOpen;
            
            if (allPicksMade && status.isOpen) {
                saveBtn.textContent = 'Save All Picks';
                saveBtn.className = 'w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium';
            } else if (!status.isOpen) {
                saveBtn.textContent = 'Picking Closed';
                saveBtn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed';
            } else {
                saveBtn.textContent = `Pick All Matches (${picksMade}/${roundData.matches.length})`;
                saveBtn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-medium cursor-not-allowed';
            }
        }

        function makePickItPick(matchId, team) {
            const status = calculatePickingStatus();
            if (!currentUser || !status.isOpen) return;
            
            if (!currentUser.pickItPicks) {
                currentUser.pickItPicks = {};
            }
            
            if (!currentUser.pickItPicks[gameData.currentRound]) {
                currentUser.pickItPicks[gameData.currentRound] = {};
            }
            
            currentUser.pickItPicks[gameData.currentRound][matchId] = team;
            
            // Update the player in gameData
            const playerIndex = gameData.players.findIndex(p => p.id === currentUser.id);
            if (playerIndex !== -1) {
                gameData.players[playerIndex] = { ...currentUser };
            }
            
            saveGameData();
            updatePickItInterface();
        }

        function savePickItPicks() {
            if (!currentUser) return;
            
            const roundData = roundFixtures[gameData.currentRound];
            const userPicks = currentUser.pickItPicks[gameData.currentRound] || {};
            
            if (Object.keys(userPicks).length !== roundData.matches.length) {
                showNotification('Please pick all matches before saving!', 'error');
                return;
            }
            
            showNotification('All picks saved successfully!', 'success');
        }

        function calculatePickItLeaderboard() {
            return gameData.players
                .filter(p => p.pickItStats && p.pickItStats.totalPicks > 0)
                .map(player => {
                    const stats = player.pickItStats;
                    return {
                        ...player,
                        percentage: stats.totalPicks > 0 ? (stats.correctPicks / stats.totalPicks) * 100 : 0
                    };
                })
                .sort((a, b) => {
                    if (b.percentage !== a.percentage) {
                        return b.percentage - a.percentage;
                    }
                    return b.pickItStats.correctPicks - a.pickItStats.correctPicks;
                });
        }

        function updatePickItLeaderboard() {
            const container = document.getElementById('pickItLeaderboardContent');
            const leaderboard = calculatePickItLeaderboard();
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No picks made yet</div>';
                return;
            }
            
            let html = '';
            leaderboard.forEach((player, index) => {
                const rank = index + 1;
                const movement = player.pickItStats.weeklyMovement || 0;
                let movementIcon = '';
                
                if (movement > 0) {
                    movementIcon = `<span class="text-green-600 text-xs">‚Üó +${movement}</span>`;
                } else if (movement < 0) {
                    movementIcon = `<span class="text-red-600 text-xs">‚Üò ${movement}</span>`;
                } else {
                    movementIcon = `<span class="text-gray-400 text-xs">-</span>`;
                }
                
                const isCurrentUser = player.id === currentUser?.id;
                const bgClass = isCurrentUser ? 'bg-green-50 border-green-200' : 'bg-gray-50';
                
                html += `
                    <div class="flex items-center justify-between p-4 border rounded-lg ${bgClass}">
                        <div class="flex items-center space-x-3">
                            <div class="text-lg font-bold text-gray-600">#${rank}</div>
                            <div>
                                <div class="font-medium ${isCurrentUser ? 'text-green-800' : 'text-gray-800'}">${player.displayName}</div>
                                <div class="text-sm text-gray-600">${player.pickItStats.correctPicks}/${player.pickItStats.totalPicks} correct</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-600">${Math.round(player.percentage)}%</div>
                            ${movementIcon}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePickItAllFixtures() {
            const selectedRound = document.getElementById('pickItRoundSelector').value;
            const content = document.getElementById('pickItAllFixturesContent');
            
            // Use the same logic as LMS fixtures but show Pick it! specific info
            updateAllFixtures(); // Reuse the existing function
            content.innerHTML = document.getElementById('allFixturesContent').innerHTML;
        }

        function openLeaderboardModal() {
            if (currentGameMode === 'pickit') {
                switchPickItTab('leaderboard');
            }
        }



        function updatePicksStatus() {
            const container = document.getElementById('picksStatusList');
            const standingPlayers = gameData.players.filter(p => !p.isEliminated);
            const status = calculatePickingStatus();
            
            if (standingPlayers.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No active players</div>';
                return;
            }
            
            // Sort players: picked first, then alphabetically
            standingPlayers.sort((a, b) => {
                if (!!a.currentPick !== !!b.currentPick) {
                    return !!b.currentPick - !!a.currentPick;
                }
                return a.displayName.localeCompare(b.displayName);
            });
            
            let html = '';
            standingPlayers.forEach(player => {
                const hasPick = !!player.currentPick;
                const lockIcon = hasPick ? 'üîí' : '‚ùå';
                const statusClass = hasPick ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
                
                // Only show actual pick if picking is closed OR user is admin OR it's the current user
                let pickText = '';
                const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
                const isCurrentUser = player.id === currentUser?.id;
                
                if (!hasPick) {
                    pickText = 'Not picked';
                } else if (status.isOpen && !isAdmin && !isCurrentUser) {
                    pickText = '<span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>';
                } else if (status.isOpen && (isAdmin || isCurrentUser)) {
                    pickText = player.currentPick;
                } else {
                    pickText = player.currentPick;
                }
                
                let profilePic = '';
                if (player.isCustomPic && player.profilePic && player.profilePic.startsWith('data:')) {
                    profilePic = `<img src="${player.profilePic}" class="w-6 h-6 rounded-full object-cover border border-gray-300" alt="Profile">`;
                } else {
                    profilePic = `<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgMFCSXJWsbmkra95ltt9Z9LJiRuMOsIBluqwF-g4&usqp=CAE&s" class="w-6 h-6 rounded-full object-cover border border-gray-300" alt="Profile" onerror="this.src=''; this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="w-6 h-6 rounded-full bg-gray-300 border border-gray-400" style="display: none;"></div>`;
                }
                
                html += `
                    <div class="p-3 border rounded-lg ${statusClass}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                ${profilePic}
                                <span class="font-medium text-sm">${player.displayName}</span>
                            </div>
                            <span class="text-lg">${lockIcon}</span>
                        </div>
                        <div class="text-xs font-medium">${pickText}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            let playersToShow = showEliminated ? 
                gameData.players.filter(p => p.isEliminated) : 
                gameData.players.filter(p => !p.isEliminated);
            const status = calculatePickingStatus();
            const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
            
            // Sort eliminated players by elimination round, then alphabetically
            // Sort standing players alphabetically
            if (showEliminated) {
                playersToShow.sort((a, b) => {
                    if (a.eliminatedInRound !== b.eliminatedInRound) {
                        return (b.eliminatedInRound || 0) - (a.eliminatedInRound || 0);
                    }
                    return a.displayName.localeCompare(b.displayName);
                });
            } else {
                playersToShow.sort((a, b) => a.displayName.localeCompare(b.displayName));
            }
            
            let html = '';
            playersToShow.forEach(player => {
                const statusIcon = player.isEliminated ? 'üíÄ' : '‚úÖ';
                const statusClass = player.isEliminated ? 'text-red-600' : 'text-green-600';
                
                let profilePic = '';
                if (player.isCustomPic && player.profilePic && player.profilePic.startsWith('data:')) {
                    profilePic = `<img src="${player.profilePic}" class="w-8 h-8 rounded-full object-cover border border-gray-300 cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(${player.id})" alt="Profile">`;
                } else {
                    profilePic = `<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgMFCSXJWsbmkra95ltt9Z9LJiRuMOsIBluqwF-g4&usqp=CAE&s" class="w-8 h-8 rounded-full object-cover border border-gray-300 cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(${player.id})" alt="Profile" onerror="this.src=''; this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="w-8 h-8 rounded-full bg-gray-300 border border-gray-400 cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(${player.id})" style="display: none;"></div>`;
                }
                
                // Calculate rounds survived
                let roundsSurvived = 0;
                if (player.isEliminated) {
                    roundsSurvived = (player.eliminatedInRound || 1) - (player.roundJoined || 1);
                } else {
                    roundsSurvived = gameData.currentRound - (player.roundJoined || 1);
                }
                
                let statusText = '';
                if (player.isEliminated) {
                    statusText = `Eliminated Round ${player.eliminatedInRound || 1}`;
                } else {
                    statusText = `${roundsSurvived} rounds survived`;
                }
                
                const isCurrentUser = player.id === currentUser?.id;
                let pickDisplay = '';
                if (player.currentPick) {
                    if (status.isOpen && !isAdmin && !isCurrentUser) {
                        pickDisplay = '<span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>';
                    } else {
                        pickDisplay = player.currentPick;
                    }
                }
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            ${profilePic}
                            <div>
                                <div class="font-medium text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="openProfileModal(${player.id})">${player.displayName}</div>
                                ${player.favoriteTeam ? `<div class="text-xs text-blue-600">${player.favoriteTeam}</div>` : ''}
                                ${player.currentPick ? `<div class="text-xs text-gray-600">Pick: ${pickDisplay}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center justify-end space-x-2">
                                <span class="${statusClass}">${statusIcon}</span>
                                <span class="text-sm text-gray-600">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="text-center text-gray-500 py-8">No players to show</div>';
        }





        function toggleEliminatedPlayers() {
            showEliminated = !showEliminated;
            const btn = document.getElementById('toggleEliminated');
            btn.textContent = showEliminated ? 'Show Standing' : 'Show Eliminated';
            updatePlayersList();
        }

        function openPicksModal() {
            document.getElementById('modalRoundNumber').textContent = gameData.currentRound;
            
            const picksContent = document.getElementById('picksContent');
            const status = calculatePickingStatus();
            let html = '';
            
            const playersWithPicks = gameData.players.filter(p => !p.isEliminated);
            
            if (playersWithPicks.length === 0) {
                html = '<div class="text-center text-gray-500 py-8">No active players</div>';
            } else {
                playersWithPicks.sort((a, b) => {
                    // Sort by pick status first (picked vs not picked), then by name
                    if (!!a.currentPick !== !!b.currentPick) {
                        return !!b.currentPick - !!a.currentPick; // Picked players first
                    }
                    return a.displayName.localeCompare(b.displayName);
                });
                
                const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
                
                playersWithPicks.forEach(player => {
                    const hasPick = player.currentPick;
                    const isCurrentUser = player.id === currentUser?.id;
                    let pickDisplay = '';
                    let statusIcon = '';
                    let statusClass = '';
                    
                    if (!hasPick) {
                        pickDisplay = '<span class="text-red-500 font-medium">‚ùå Not picked yet</span>';
                        statusIcon = '‚è≥';
                        statusClass = 'bg-red-50 border-l-4 border-red-400';
                    } else {
                        statusIcon = '‚úÖ';
                        // Only show actual pick if picking is closed OR user is admin OR it's current user
                        if (status.isOpen && !isAdmin && !isCurrentUser) {
                            pickDisplay = `<span class="font-medium text-green-600">üîí <span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span></span>`;
                        } else if (status.isOpen && (isAdmin || isCurrentUser)) {
                            pickDisplay = `<span class="font-medium text-green-600">üîí ${player.currentPick}</span>`;
                        } else {
                            pickDisplay = `<span class="font-medium text-green-600">üîí ${player.currentPick}</span>`;
                        }
                        statusClass = 'bg-green-50 border-l-4 border-green-400';
                    }
                    
                    html += `
                        <div class="flex justify-between items-center p-3 rounded-lg ${statusClass}">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${statusIcon}</span>
                                <span class="font-medium text-gray-800">${player.displayName}</span>
                            </div>
                            ${pickDisplay}
                        </div>
                    `;
                });
            }
            
            picksContent.innerHTML = html;
            document.getElementById('picksModal').classList.remove('hidden');
        }

        function closePicksModal() {
            document.getElementById('picksModal').classList.add('hidden');
        }

        function openPlayerListModal(type) {
            const modal = document.getElementById('playerListModal');
            const title = document.getElementById('playerListTitle');
            const content = document.getElementById('playerListContent');
            
            let players = [];
            let titleText = '';
            let emptyMessage = '';
            
            if (type === 'standing') {
                players = gameData.players.filter(p => !p.isEliminated);
                titleText = `üü¢ Players Standing (${players.length})`;
                emptyMessage = 'No players remaining';
            } else if (type === 'eliminated') {
                players = gameData.players.filter(p => p.isEliminated);
                titleText = `üíÄ Players Eliminated (${players.length})`;
                emptyMessage = 'No players eliminated yet';
            }
            
            title.textContent = titleText;
            
            if (players.length === 0) {
                content.innerHTML = `<div class="text-center text-gray-500 py-8">${emptyMessage}</div>`;
            } else {
                players.sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                let html = '';
                const status = calculatePickingStatus();
                const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
                players.forEach(player => {
                    let profilePic = '';
                    if (player.isCustomPic && player.profilePic && player.profilePic.startsWith('data:')) {
                        profilePic = `<img src="${player.profilePic}" class="w-8 h-8 rounded-full object-cover border border-gray-300 cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(${player.id})" alt="Profile">`;
                    } else {
                        profilePic = `<div class="w-8 h-8 rounded-full bg-gray-300 border border-gray-400 cursor-pointer hover:scale-110 transition-transform" onclick="openProfileModal(${player.id})"></div>`;
                    }
                    const isCurrentUser = player.id === currentUser?.id;
                    let pickDisplay = '';
                    if (player.currentPick) {
                        if (status.isOpen && !isAdmin && !isCurrentUser) {
                            pickDisplay = '<span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>';
                        } else {
                            pickDisplay = player.currentPick;
                        }
                    }
                    
                    html += `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-2 mb-1">
                                ${profilePic}
                                <div class="font-medium text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="openProfileModal(${player.id})">${player.displayName}</div>
                                ${player.favoriteTeam ? `<span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">${player.favoriteTeam}</span>` : ''}
                            </div>
                            ${player.currentPick ? `<div class="text-xs text-gray-600 ml-10">Pick: ${pickDisplay}</div>` : ''}
                        </div>
                    `;
                });
                content.innerHTML = html;
            }
            
            modal.classList.remove('hidden');
        }

        function closePlayerListModal() {
            document.getElementById('playerListModal').classList.add('hidden');
        }

        function openProfileModal(playerId) {
            const player = gameData.players.find(p => p.id == playerId);
            if (!player) return;
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            const roundsPlayed = gameData.currentRound - (player.roundJoined || 1);
            const roundsSurvived = player.isEliminated ? (player.eliminatedInRound - (player.roundJoined || 1)) : roundsPlayed;
            
            let pickHistory = '';
            const status = calculatePickingStatus();
            const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
            const isCurrentUser = player.id === currentUser?.id;
            
            if (player.usedTeams.length > 0) {
                pickHistory = player.usedTeams.map((team, index) => {
                    const roundNum = (player.roundJoined || 1) + index;
                    let teamDisplay = team;
                    
                    // Blur current round pick if picking is still open and not admin/current user
                    if (roundNum === gameData.currentRound && status.isOpen && !isAdmin && !isCurrentUser) {
                        teamDisplay = '<span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>';
                    }
                    
                    return `<div class="flex justify-between items-center py-1">
                        <span>Round ${roundNum}:</span>
                        <span class="font-medium">${teamDisplay}</span>
                    </div>`;
                }).join('');
            } else {
                pickHistory = '<div class="text-gray-500 text-center py-4">No picks made yet</div>';
            }
            
            let seasonStatus = '';
            if (player.isEliminated) {
                seasonStatus = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-2xl">üíÄ</span>
                            <span class="font-semibold text-red-800">Eliminated</span>
                        </div>
                        <p class="text-sm text-red-700">Round ${player.eliminatedInRound}</p>
                        <p class="text-xs text-red-600 mt-1">${player.eliminatedBy || 'Team lost'}</p>
                    </div>
                `;
            } else {
                seasonStatus = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-2xl">‚úÖ</span>
                            <span class="font-semibold text-green-800">Still Standing</span>
                        </div>
                        <p class="text-sm text-green-700">Survived ${roundsSurvived} rounds</p>
                        ${player.currentPick ? `<p class="text-xs text-green-600 mt-1">Current pick: ${status.isOpen && !isAdmin && !isCurrentUser ? '<span class="blur-sm">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span>' : player.currentPick}</p>` : ''}
                    </div>
                `;
            }
            
            const joinDate = player.joinDate ? new Date(player.joinDate).toLocaleDateString() : 'Unknown';
            
            let profilePicDisplay = '';
            if (player.isCustomPic && player.profilePic && player.profilePic.startsWith('data:')) {
                profilePicDisplay = `<img src="${player.profilePic}" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-gray-200 mb-3" alt="Profile">`;
            } else {
                profilePicDisplay = `<div class="w-24 h-24 rounded-full bg-gray-300 border-4 border-gray-200 mx-auto mb-3"></div>`;
            }
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    ${profilePicDisplay}
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">${player.displayName}</h2>
                    ${player.favoriteTeam ? `<p class="text-blue-600 font-medium">üíô ${player.favoriteTeam} Fan</p>` : ''}
                    <p class="text-sm text-gray-500">Joined: ${joinDate}</p>
                </div>
                
                <div class="space-y-4">
                    ${seasonStatus}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-gray-800">${roundsSurvived}</div>
                            <div class="text-sm text-gray-600">Rounds Survived</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-gray-800">${player.usedTeams.length}</div>
                            <div class="text-sm text-gray-600">Teams Used</div>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Pick History</h3>
                        <div class="max-h-32 overflow-y-auto">
                            ${pickHistory}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function openSettingsModal() {
            if (!currentUser) return;
            
            const modal = document.getElementById('settingsModal');
            
            document.getElementById('settingsDisplayName').value = currentUser.displayName;
            document.getElementById('settingsFavoriteTeam').value = currentUser.favoriteTeam || '';
            
            if (currentUser.isCustomPic && currentUser.profilePic && currentUser.profilePic.startsWith('data:')) {
                document.getElementById('settingsCustomPicImage').src = currentUser.profilePic;
                document.getElementById('settingsCustomPicPreview').classList.remove('hidden');
                window.tempCustomPic = currentUser.profilePic;
            } else {
                document.getElementById('settingsCustomPicPreview').classList.add('hidden');
                window.tempCustomPic = null;
            }
            
            modal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const newDisplayName = document.getElementById('settingsDisplayName').value.trim();
            const newFavoriteTeam = document.getElementById('settingsFavoriteTeam').value;
            
            if (!newDisplayName) {
                showNotification('Display name cannot be empty', 'error');
                return;
            }
            
            if (containsProfanity(newDisplayName)) {
                showNotification('Display name contains inappropriate language. Please choose a different name.', 'error');
                return;
            }
            
            let newProfilePic = currentUser.profilePic;
            let isCustomPic = false;
            
            if (window.tempCustomPic) {
                newProfilePic = window.tempCustomPic;
                isCustomPic = true;
            } else {
                newProfilePic = null;
                isCustomPic = false;
            }
            
            currentUser.displayName = newDisplayName;
            currentUser.favoriteTeam = newFavoriteTeam;
            currentUser.profilePic = newProfilePic;
            currentUser.isCustomPic = isCustomPic;
            
            const playerIndex = gameData.players.findIndex(p => p.id === currentUser.id);
            if (playerIndex !== -1) {
                gameData.players[playerIndex] = { ...currentUser };
            }
            
            saveGameData();
            updateUI();
            closeSettingsModal();
            
            showNotification('Profile updated successfully!', 'success');
        }

        function switchAdminTab(tab) {
            const scoresTab = document.getElementById('adminScoresTab');
            const playersTab = document.getElementById('adminPlayersTab');
            const playoffsTab = document.getElementById('adminPlayoffsTab');
            const scoresSection = document.getElementById('adminScoresSection');
            const playersSection = document.getElementById('adminPlayersSection');
            const playoffsSection = document.getElementById('adminPlayoffsSection');
            
            // Reset all tabs
            scoresTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            playersTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            playoffsTab.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium';
            scoresSection.classList.add('hidden');
            playersSection.classList.add('hidden');
            playoffsSection.classList.add('hidden');
            
            if (tab === 'scores') {
                scoresTab.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';
                scoresSection.classList.remove('hidden');
                populateAdminScores();
            } else if (tab === 'players') {
                playersTab.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';
                playersSection.classList.remove('hidden');
                populateAdminPlayers();
            } else if (tab === 'playoffs') {
                playoffsTab.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg font-medium';
                playoffsSection.classList.remove('hidden');
                populateAdminPlayoffs();
            }
        }

        function populateAdminPlayoffs() {
            if (currentUser?.email !== 'sacksjordan@gmail.com') return;
            
            // Load current playoff settings
            if (gameData.semiTeams) {
                document.getElementById('sf1Home').value = gameData.semiTeams.sf1Home || 'TBD';
                document.getElementById('sf1Away').value = gameData.semiTeams.sf1Away || 'TBD';
                document.getElementById('sf2Home').value = gameData.semiTeams.sf2Home || 'TBD';
                document.getElementById('sf2Away').value = gameData.semiTeams.sf2Away || 'TBD';
            }
            
            if (gameData.semiTimes) {
                document.getElementById('sf1Time').value = gameData.semiTimes.sf1Time || '';
                document.getElementById('sf2Time').value = gameData.semiTimes.sf2Time || '';
            }
            
            if (gameData.finalTeams) {
                document.getElementById('finalHome').value = gameData.finalTeams.finalHome || 'TBD';
                document.getElementById('finalAway').value = gameData.finalTeams.finalAway || 'TBD';
            }
            
            if (gameData.finalTimes) {
                document.getElementById('finalTime').value = gameData.finalTimes.finalTime || '';
            }
        }

        function openAdminModal() {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            switchAdminTab('scores');
            document.getElementById('adminModal').classList.remove('hidden');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.add('hidden');
        }

        function populateAdminScores() {
            const container = document.getElementById('adminScoreContent');
            const selectedRound = document.getElementById('adminRoundSelector').value;
            const roundData = roundFixtures[selectedRound];
            
            if (!roundData || !roundData.matches) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No matches found for this round</div>';
                return;
            }
            
            let html = '';
            
            roundData.matches.forEach(game => {
                const currentScore = { homeScore: 0, awayScore: 0 };
                const isFinished = gameData.matchResults[game.id]?.finished || false;
                
                html += `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold">${game.home} vs ${game.away}</h4>
                            <div class="text-right">
                                <span class="text-sm px-2 py-1 rounded ${isFinished ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${isFinished ? 'Finished' : 'Upcoming'}
                                </span>
                                <div class="text-xs text-gray-500 mt-1">Kick-off: ${game.time}</div>
                                <div class="text-xs text-gray-500">${game.day}</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Winner</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setGameWinner('${game.id}', '${game.home}', '${game.away}', ${selectedRound})" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 text-sm ${gameData.matchResults[game.id]?.winner === game.home ? 'bg-blue-100 border-blue-500' : ''}">
                                    ${game.home}
                                </button>
                                <button onclick="setGameWinner('${game.id}', '${game.away}', '${game.home}', ${selectedRound})" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 text-sm ${gameData.matchResults[game.id]?.winner === game.away ? 'bg-blue-100 border-blue-500' : ''}">
                                    ${game.away}
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="markGameFinished('${game.id}', ${selectedRound})" 
                                    class="flex-1 bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm ${!gameData.matchResults[game.id]?.winner ? 'opacity-50 cursor-not-allowed' : ''}" 
                                    ${!gameData.matchResults[game.id]?.winner ? 'disabled' : ''}>
                                Mark Finished
                            </button>
                            ${isFinished ? `<button onclick="resetGameResult('${game.id}')" 
                                    class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm">
                                Reset
                            </button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function setGameWinner(gameId, winner, loser, roundNum) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            if (!gameData.matchResults[gameId]) {
                gameData.matchResults[gameId] = {};
            }
            
            gameData.matchResults[gameId].winner = winner;
            gameData.matchResults[gameId].roundNum = roundNum;
            saveGameData();
            populateAdminScores();
            showNotification(`Winner set: ${winner}`, 'info');
        }

        function markGameFinished(gameId, roundNum) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const result = gameData.matchResults[gameId];
            if (!result || !result.winner) {
                showNotification('Please select a winner first', 'error');
                return;
            }
            
            result.finished = true;
            result.roundNum = roundNum;
            
            // Process eliminations for LMS - check all players who picked teams in this match
            const roundData = roundFixtures[roundNum];
            const match = roundData.matches.find(m => m.id === gameId);
            
            if (match) {
                let eliminatedCount = 0;
                gameData.players.forEach(player => {
                    // LMS elimination logic
                    if (!player.isEliminated && player.currentPick && 
                        (player.currentPick === match.home || player.currentPick === match.away) && 
                        player.currentPick !== result.winner) {
                        
                        player.isEliminated = true;
                        player.eliminatedInRound = parseInt(roundNum);
                        player.eliminatedBy = `${player.currentPick} lost to ${result.winner}`;
                        eliminatedCount++;
                        
                        if (player.id === currentUser?.id) {
                            showNotification(`üíÄ You've been eliminated! ${player.currentPick} lost to ${result.winner}`, 'error');
                        }
                    }
                    
                    // Pick it! stats update
                    if (player.pickItPicks && player.pickItPicks[roundNum] && player.pickItPicks[roundNum][gameId]) {
                        if (!player.pickItStats) {
                            player.pickItStats = {
                                totalPicks: 0,
                                correctPicks: 0,
                                percentage: 0,
                                weeklyMovement: 0,
                                previousRank: null
                            };
                        }
                        
                        const userPick = player.pickItPicks[roundNum][gameId];
                        player.pickItStats.totalPicks++;
                        
                        if (userPick === result.winner) {
                            player.pickItStats.correctPicks++;
                        }
                        
                        // Update percentage
                        player.pickItStats.percentage = (player.pickItStats.correctPicks / player.pickItStats.totalPicks) * 100;
                    }
                });
                
                // Calculate Pick it! leaderboard movements
                updatePickItRankings();
                
                if (eliminatedCount > 0) {
                    showNotification(`Match finished: ${result.winner} wins! ${eliminatedCount} player(s) eliminated.`, 'success');
                } else {
                    showNotification(`Match finished: ${result.winner} wins!`, 'success');
                }
            }
            
            saveGameData();
            updateUI();
            populateAdminScores();
        }

        function updatePickItRankings() {
            const leaderboard = calculatePickItLeaderboard();
            
            gameData.players.forEach(player => {
                if (player.pickItStats) {
                    const currentRank = leaderboard.findIndex(p => p.id === player.id) + 1;
                    const previousRank = player.pickItStats.previousRank;
                    
                    if (previousRank && currentRank > 0) {
                        player.pickItStats.weeklyMovement = previousRank - currentRank;
                    }
                    
                    player.pickItStats.previousRank = currentRank > 0 ? currentRank : null;
                }
            });
        }

        function resetGameResult(gameId) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            if (confirm('Reset this match result? This will restore any eliminated players from this match.')) {
                const result = gameData.matchResults[gameId];
                if (result && result.finished) {
                    // Find players who were eliminated by this match and restore them
                    const roundNum = result.roundNum;
                    const roundData = roundFixtures[roundNum];
                    const match = roundData.matches.find(m => m.id === gameId);
                    
                    if (match) {
                        gameData.players.forEach(player => {
                            if (player.isEliminated && player.eliminatedInRound === roundNum && 
                                player.eliminatedBy && player.eliminatedBy.includes(result.winner)) {
                                player.isEliminated = false;
                                delete player.eliminatedInRound;
                                delete player.eliminatedBy;
                            }
                        });
                    }
                    
                    // Reset the match result
                    delete gameData.matchResults[gameId];
                    
                    saveGameData();
                    updateUI();
                    populateAdminScores();
                    showNotification('Match result reset and players restored', 'success');
                }
            }
        }



        function populateAdminPlayers() {
            if (currentUser?.email !== 'sacksjordan@gmail.com') return;
            
            const container = document.getElementById('adminPlayerContent');
            let html = '';
            
            const sortedPlayers = [...gameData.players].sort((a, b) => {
                if (a.isEliminated !== b.isEliminated) {
                    return a.isEliminated ? 1 : -1;
                }
                return a.displayName.localeCompare(b.displayName);
            });
            
            sortedPlayers.forEach(player => {
                const statusClass = player.isEliminated ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
                const statusIcon = player.isEliminated ? 'üíÄ' : '‚úÖ';
                const statusText = player.isEliminated ? 'ELIMINATED' : 'STANDING';
                
                const roundData = roundFixtures[gameData.currentRound];
                const availableTeams = roundData ? roundData.teams : [];
                
                html += `
                    <div class="border rounded-lg p-4 ${statusClass}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-lg">${statusIcon} ${player.displayName}</h4>
                                <p class="text-sm text-gray-600">${player.email}</p>
                                <p class="text-sm font-medium ${player.isEliminated ? 'text-red-600' : 'text-green-600'}">${statusText}</p>
                                ${player.isEliminated && player.eliminatedBy ? `<p class="text-xs text-gray-500 mt-1">${player.eliminatedBy}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Round ${player.roundJoined || 1} player</p>
                                <p class="text-sm text-gray-600">Used ${player.usedTeams.length} teams</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Player Status</label>
                                <div class="flex space-x-2 mb-2">
                                    <button onclick="setPlayerStatus('${player.id}', false)" 
                                            class="px-3 py-1 text-sm rounded ${!player.isEliminated ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'} hover:opacity-80">
                                        Standing
                                    </button>
                                    <button onclick="setPlayerStatus('${player.id}', true)" 
                                            class="px-3 py-1 text-sm rounded ${player.isEliminated ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'} hover:opacity-80">
                                        Eliminated
                                    </button>
                                </div>
                                ${player.isEliminated ? `
                                    <div class="flex space-x-2">
                                        <select id="eliminatedRound_${player.id}" class="flex-1 text-xs border border-gray-300 rounded px-2 py-1">
                                            ${Array.from({length: 18}, (_, i) => i + 1).map(round => 
                                                `<option value="${round}" ${(player.eliminatedInRound || 1) === round ? 'selected' : ''}>Round ${round}</option>`
                                            ).join('')}
                                        </select>
                                        <button onclick="updateEliminationRound('${player.id}')" 
                                                class="px-2 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600">
                                            Update
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pick Management</label>
                                <div class="space-y-2">
                                    <div class="flex space-x-2">
                                        <select id="pickRound_${player.id}" class="text-sm border border-gray-300 rounded px-2 py-1">
                                            ${Array.from({length: 18}, (_, i) => i + 1).map(round => 
                                                `<option value="${round}" ${gameData.currentRound === round ? 'selected' : ''}>Round ${round}</option>`
                                            ).join('')}
                                        </select>
                                        <select id="pick_${player.id}" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1">
                                            <option value="">No Pick</option>
                                            ${availableTeams.map(team => 
                                                `<option value="${team}" ${player.currentPick === team ? 'selected' : ''}>${team}</option>`
                                            ).join('')}
                                        </select>
                                        <button onclick="setPlayerPick('${player.id}')" 
                                                class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                                            Update
                                        </button>
                                    </div>
                                    ${player.currentPick ? `<p class="text-xs text-gray-500">Current Round ${gameData.currentRound}: ${player.currentPick}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${player.usedTeams.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-sm font-medium text-gray-700 mb-1">Used Teams:</p>
                                <div class="flex flex-wrap gap-1">
                                    ${player.usedTeams.map(team => 
                                        `<span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded">${team}</span>`
                                    ).join('')}
                                </div>
                                <button onclick="clearUsedTeams('${player.id}')" 
                                        class="mt-2 px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600">
                                    Clear Used Teams
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function setPlayerStatus(playerId, isEliminated) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const player = gameData.players.find(p => p.id == playerId);
            if (!player) return;
            
            const wasEliminated = player.isEliminated;
            player.isEliminated = isEliminated;
            
            if (isEliminated && !wasEliminated) {
                player.eliminatedInRound = gameData.currentRound;
                player.eliminatedBy = 'Admin override';
                showNotification(`${player.displayName} marked as eliminated`, 'info');
            } else if (!isEliminated && wasEliminated) {
                delete player.eliminatedInRound;
                delete player.eliminatedBy;
                showNotification(`${player.displayName} restored to standing`, 'success');
            }
            
            if (player.id === currentUser?.id) {
                currentUser = player;
                if (isEliminated) {
                    showNotification('üíÄ Admin has marked you as eliminated', 'error');
                } else {
                    showNotification('üéâ Admin has restored you to standing!', 'success');
                }
            }
            
            saveGameData();
            updateUI();
            populateAdminPlayers();
        }

        function setPlayerPick(playerId) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const player = gameData.players.find(p => p.id == playerId);
            const selectedRound = parseInt(document.getElementById(`pickRound_${playerId}`).value);
            const newPick = document.getElementById(`pick_${playerId}`).value;
            
            if (!player) return;
            
            // Handle current round pick
            if (selectedRound === gameData.currentRound) {
                const oldPick = player.currentPick;
                player.currentPick = newPick || null;
                const startRound = player.roundJoined || 1;
                const roundIndex = Math.max(0, (gameData.currentRound || 1) - startRound);
                if (!Array.isArray(player.usedTeams)) player.usedTeams = [];
                if (newPick) {
                    if (roundIndex < player.usedTeams.length) {
                        player.usedTeams[roundIndex] = newPick;
                    } else if (roundIndex === player.usedTeams.length) {
                        player.usedTeams.push(newPick);
                    } else {
                        while (player.usedTeams.length < roundIndex) player.usedTeams.push(null);
                        player.usedTeams.push(newPick);
                    }
                } else {
                    if (roundIndex < player.usedTeams.length) {
                        player.usedTeams[roundIndex] = null;
                    }
                }
                
                if (oldPick !== newPick) {
                    const pickText = newPick ? `${newPick}` : 'No pick';
                    showNotification(`${player.displayName}'s Round ${selectedRound} pick updated to: ${pickText}`, 'success');
                    
                    if (player.id === currentUser?.id) {
                        currentUser = player;
                        if (newPick) {
                            showNotification(`üîß Admin changed your Round ${selectedRound} pick to: ${newPick}`, 'info');
                        } else {
                            showNotification(`üîß Admin cleared your Round ${selectedRound} pick`, 'info');
                        }
                    }
                }
            } else {
                // Handle Pick it! picks for other rounds
                if (!player.pickItPicks) player.pickItPicks = {};
                if (!player.pickItPicks[selectedRound]) player.pickItPicks[selectedRound] = {};
                
                // For simplicity, we'll just show a message that this would need match-specific handling
                showNotification(`Pick it! management for Round ${selectedRound} requires match-specific selection`, 'info');
                return;
            }
            
            saveGameData();
            updateUI();
            populateAdminPlayers();
        }

        function clearUsedTeams(playerId) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const player = gameData.players.find(p => p.id == playerId);
            if (!player) return;
            
            if (confirm(`Clear all used teams for ${player.displayName}? This will allow them to pick any team again.`)) {
                player.usedTeams = [];
                showNotification(`${player.displayName}'s used teams cleared`, 'success');
                
                if (player.id === currentUser?.id) {
                    currentUser = player;
                    showNotification('üîß Admin cleared your used teams - you can now pick any team!', 'success');
                }
                
                saveGameData();
                updateUI();
                populateAdminPlayers();
            }
        }

        function updateEliminationRound(playerId) {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const player = gameData.players.find(p => p.id == playerId);
            const newRound = parseInt(document.getElementById(`eliminatedRound_${playerId}`).value);
            
            if (!player) return;
            
            player.eliminatedInRound = newRound;
            showNotification(`${player.displayName}'s elimination round updated to Round ${newRound}`, 'success');
            
            if (player.id === currentUser?.id) {
                currentUser = player;
            }
            
            saveGameData();
            updateUI();
            populateAdminPlayers();
        }

        // Chat functionality
        function toggleChat() {
            const sidebar = document.getElementById('chatSidebar');
            sidebar.classList.toggle('translate-x-full');
            if (!sidebar.classList.contains('translate-x-full')) {
                loadChatMessages();
            }
        }

        function closeChat() {
            document.getElementById('chatSidebar').classList.add('translate-x-full');
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            if (containsProfanity(message)) {
                showNotification('Message contains inappropriate language and cannot be sent.', 'error');
                return;
            }
            
            const chatMessage = {
                id: Date.now(),
                sender: currentUser.displayName,
                senderId: currentUser.id,
                message: message,
                timestamp: new Date().toISOString(),
                isAdmin: currentUser.email === 'sacksjordan@gmail.com'
            };
            
            if (!gameData.chatMessages) {
                gameData.chatMessages = [];
            }
            
            gameData.chatMessages.push(chatMessage);
            saveGameData();
            
            input.value = '';
            updateCharCount();
            loadChatMessages();
            
            showNotification('Message sent', 'success');
            showNewMessageNotification(chatMessage);
        }

        function loadChatMessages() {
            const container = document.getElementById('chatMessages');
            const messages = gameData.chatMessages || [];
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>';
                return;
            }
            
            let html = '';
            const isAdmin = currentUser?.email === 'sacksjordan@gmail.com';
            
            messages.forEach(msg => {
                // Show message if: not private, or user is admin, or user sent the private message
                const canSeeMessage = !msg.isPrivate || isAdmin || msg.senderId === currentUser?.id;
                
                if (canSeeMessage) {
                    const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const isOwnMessage = msg.senderId === currentUser?.id;
                    const messageClass = isOwnMessage ? 'bg-blue-100 ml-8' : 'bg-gray-100 mr-8';
                    const privateLabel = msg.isPrivate ? '<span class="text-xs text-red-600">[Private to Admin]</span> ' : '';
                    const adminLabel = msg.isAdmin ? '<span class="text-xs text-purple-600">[Admin]</span> ' : '';
                    
                    html += `
                        <div class="mb-3 p-3 rounded-lg ${messageClass}">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-medium text-sm">${adminLabel}${msg.sender}</span>
                                <span class="text-xs text-gray-500">${time}</span>
                            </div>
                            <div class="text-sm">${privateLabel}${msg.message}</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function updateCharCount() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('charCount');
            counter.textContent = `${input.value.length}/200`;
        }

        // Playoff management functions
        function updateSemiFinals() {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const sf1Home = document.getElementById('sf1Home').value;
            const sf1Away = document.getElementById('sf1Away').value;
            const sf1Time = document.getElementById('sf1Time').value;
            const sf2Home = document.getElementById('sf2Home').value;
            const sf2Away = document.getElementById('sf2Away').value;
            const sf2Time = document.getElementById('sf2Time').value;
            
            if (!gameData.semiTeams) gameData.semiTeams = {};
            if (!gameData.semiTimes) gameData.semiTimes = {};
            
            gameData.semiTeams.sf1Home = sf1Home;
            gameData.semiTeams.sf1Away = sf1Away;
            gameData.semiTeams.sf2Home = sf2Home;
            gameData.semiTeams.sf2Away = sf2Away;
            gameData.semiTimes.sf1Time = sf1Time;
            gameData.semiTimes.sf2Time = sf2Time;
            
            // Update the fixtures
            roundFixtures[17].matches[0].home = sf1Home;
            roundFixtures[17].matches[0].away = sf1Away;
            roundFixtures[17].matches[0].time = sf1Time;
            roundFixtures[17].matches[1].home = sf2Home;
            roundFixtures[17].matches[1].away = sf2Away;
            roundFixtures[17].matches[1].time = sf2Time;
            
            saveGameData();
            showNotification('Semi Finals updated successfully!', 'success');
        }

        function updateFinal() {
            if (currentUser?.email !== 'sacksjordan@gmail.com') {
                showNotification('Access denied - Admin only', 'error');
                return;
            }
            
            const finalHome = document.getElementById('finalHome').value;
            const finalAway = document.getElementById('finalAway').value;
            const finalTime = document.getElementById('finalTime').value;
            
            if (!gameData.finalTeams) gameData.finalTeams = {};
            if (!gameData.finalTimes) gameData.finalTimes = {};
            
            gameData.finalTeams.finalHome = finalHome;
            gameData.finalTeams.finalAway = finalAway;
            gameData.finalTimes.finalTime = finalTime;
            
            // Update the fixtures
            roundFixtures[18].matches[0].home = finalHome;
            roundFixtures[18].matches[0].away = finalAway;
            roundFixtures[18].matches[0].time = finalTime;
            
            saveGameData();
            showNotification('Final updated successfully!', 'success');
        }

        // Password reset functions
        function showPasswordReset() {
            document.getElementById('passwordResetForm').classList.remove('hidden');
            document.getElementById('forgotPasswordBtn').style.display = 'none';
        }

        function hidePasswordReset() {
            document.getElementById('passwordResetForm').classList.add('hidden');
            document.getElementById('forgotPasswordBtn').style.display = 'block';
            // Clear form fields
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetDisplayName').value = '';
            document.getElementById('newPassword').value = '';
        }

        function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const displayName = document.getElementById('resetDisplayName').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            
            if (!email || !displayName || !newPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters long', 'error');
                return;
            }
            
            // Find player by email and display name for security
            const player = gameData.players.find(p => 
                p.email.toLowerCase() === email.toLowerCase() && 
                p.displayName.toLowerCase() === displayName.toLowerCase()
            );
            
            if (!player) {
                showNotification('No account found with that email and display name combination', 'error');
                return;
            }
            
            // Update password
            player.password = newPassword;
            saveGameData();
            
            hidePasswordReset();
            showNotification('Password reset successfully! You can now login with your new password.', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500',
                'warning': 'bg-yellow-500'
            }[type] || 'bg-gray-500';
            
            notification.className += ` ${bgColor} text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984addaa85f954c9',t:'MTc1ODgwNjkxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script>
  function togglePicks() {
    const picks = document.querySelectorAll('.player-pick');
    picks.forEach(pick => {
      pick.classList.toggle('blur');
    });
  }
</script></body>
</html>
